I"°<p>æœ¬äººä¹Ÿçœ‹ç€ä¼—å¤§ç¥çš„æ–‡ç« æ‰å¯¹runloopæœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œå¸Œæœ›é€šè¿‡è¿™ç¯‡æ–‡ç« æ¥è®°å½•å¹¶åŠ æ·±å¯¹runloopçš„ç†è§£ã€‚<a href="https://opensource.apple.com/tarballs/CF/">CFRunloopæºä»£ç </a></p>

<h3 id="ä¸€runloopç®€ä»‹">ä¸€ã€RunLoopç®€ä»‹</h3>

<p>RunLoop å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç®¡ç†äº†å…¶éœ€è¦å¤„ç†çš„äº‹ä»¶å’Œæ¶ˆæ¯ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªå…¥å£å‡½æ•°æ¥æ‰§è¡Œä¸Šé¢ Event Loop çš„é€»è¾‘ã€‚çº¿ç¨‹æ‰§è¡Œäº†è¿™ä¸ªå‡½æ•°åï¼Œå°±ä¼šä¸€ç›´å¤„äºè¿™ä¸ªå‡½æ•°å†…éƒ¨ â€œæ¥å—æ¶ˆæ¯-&gt;ç­‰å¾…-&gt;å¤„ç†â€ çš„å¾ªç¯ä¸­ï¼Œç›´åˆ°è¿™ä¸ªå¾ªç¯ç»“æŸï¼ˆæ¯”å¦‚ä¼ å…¥ quit çš„æ¶ˆæ¯ï¼‰ï¼Œå‡½æ•°è¿”å›ã€‚</p>

<p>OSX/iOS ç³»ç»Ÿä¸­ï¼Œæä¾›äº†ä¸¤ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼š<code class="highlighter-rouge">NSRunLoop</code> å’Œ <code class="highlighter-rouge">CFRunLoopRef</code>ã€‚</p>

<ul>
  <li><code class="highlighter-rouge">CFRunLoopRef</code> æ˜¯åœ¨ <code class="highlighter-rouge">CoreFoundation</code> æ¡†æ¶å†…çš„ï¼Œå®ƒæä¾›äº†çº¯ C å‡½æ•°çš„ APIï¼Œæ‰€æœ‰è¿™äº› API éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
  <li><code class="highlighter-rouge">NSRunLoop</code> æ˜¯åŸºäº <code class="highlighter-rouge">CFRunLoopRef</code> çš„å°è£…ï¼Œæä¾›äº†é¢å‘å¯¹è±¡çš„ APIï¼Œä½†æ˜¯è¿™äº› API ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ul>

<h3 id="äºŒrunloopä¸çº¿ç¨‹å…³ç³»">äºŒã€RunLoopä¸çº¿ç¨‹å…³ç³»</h3>

<p>RunLoop å’Œçº¿ç¨‹æ˜¯æ¯æ¯ç›¸å…³çš„ï¼Œæˆ‘ä»¬çŸ¥é“çº¿ç¨‹çš„ä½œç”¨æ˜¯ç”¨æ¥æ‰§è¡Œç‰¹å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ‰§è¡Œå®Œä¹‹åå°±ä¼šé€€å‡ºï¼Œå°±ä¸èƒ½å†æ‰§è¡Œä»»åŠ¡äº†ã€‚è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦é‡‡ç”¨ä¸€ç§æ–¹å¼æ¥è®©çº¿ç¨‹èƒ½å¤Ÿä¸æ–­åœ°å¤„ç†ä»»åŠ¡ï¼Œå¹¶ä¸é€€å‡ºã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±æœ‰äº† RunLoopã€‚</p>

<p>è‹¹æœä¸å…è®¸ç›´æ¥åˆ›å»º RunLoopï¼Œå®ƒåªæä¾›äº†ä¸¤ä¸ªè‡ªåŠ¨è·å–çš„å‡½æ•°ï¼š<code class="highlighter-rouge">CFRunLoopGetMain()</code> å’Œ <code class="highlighter-rouge">CFRunLoopGetCurrent()</code>ã€‚ è¿™ä¸¤ä¸ªå‡½æ•°æºç ä¸ºä¸‹é¢è¿™æ ·:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// å…¨å±€çš„Dictionaryï¼Œkey æ˜¯ pthread_tï¼Œ value æ˜¯ CFRunLoopRef
static CFMutableDictionaryRef __CFRunLoops = NULL;
// è®¿é—® __CFRunLoops æ—¶çš„é”
static CFSpinLock_t loopsLock = CFSpinLockInit;

CF_EXPORT CFRunLoopRef _CFRunLoopGet0(pthread_t t) {
    if (pthread_equal(t, kNilPthreadT)) {
				t = pthread_main_thread_np();
    }
    __CFSpinLock(&amp;loopsLock);
    if (!__CFRunLoops) {
    		// ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶ï¼Œåˆå§‹åŒ–å…¨å±€ __CFRunLoopsï¼Œå¹¶å…ˆä¸ºä¸»çº¿ç¨‹åˆ›å»ºä¸€ä¸ª RunLoop
        __CFSpinUnlock(&amp;loopsLock);
				CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, &amp;kCFTypeDictionaryValueCallBacks);
				CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np());
				CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop);
        if (!OSAtomicCompareAndSwapPtrBarrier(NULL, dict, (void * volatile *)&amp;__CFRunLoops)) {
            CFRelease(dict);
        }
				CFRelease(mainLoop);
        __CFSpinLock(&amp;loopsLock);
    }
    // ç›´æ¥ä» __CFRunLoops é‡Œè·å–
    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));
    __CFSpinUnlock(&amp;loopsLock);
    if (!loop) {
    		// è·å–ä¸åˆ°æ—¶ï¼Œåˆ›å»ºä¸€ä¸ª
				CFRunLoopRef newLoop = __CFRunLoopCreate(t);
        __CFSpinLock(&amp;loopsLock);
				loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));
				if (!loop) {
	    			CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);
	    			loop = newLoop;
				}
   			 __CFSpinUnlock(&amp;loopsLock);
				CFRelease(newLoop);
    }
    if (pthread_equal(t, pthread_self())) {
    		// æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“çº¿ç¨‹é”€æ¯æ—¶ï¼Œé¡ºä¾¿ä¹Ÿé”€æ¯å…¶å¯¹åº”çš„ RunLoopã€‚
       	_CFSetTSD(__CFTSDKeyRunLoop, (void *)loop, NULL);
        if (0 == _CFGetTSD(__CFTSDKeyRunLoopCntr)) {
            _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(PTHREAD_DESTRUCTOR_ITERATIONS-1), (void (* (void *))__CFFinalizeRunLoop);
        }
    }
    return loop;
}

CFRunLoopRef CFRunLoopGetMain(void) {
    CHECK_FOR_FORK();
    static CFRunLoopRef __main = NULL; // no retain needed
    if (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np()); // no CAS needed
    return __main;
}

CFRunLoopRef CFRunLoopGetCurrent(void) {
    CHECK_FOR_FORK();
    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);
    if (rl) return rl;
    return _CFRunLoopGet0(pthread_self());
}

void CFRunLoopRun(void) {	/* DOES CALLOUT */
    int32_t result;
    do {
        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, 1.0e10, false);
        CHECK_FOR_FORK();
    } while (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);
}
</code></pre></div></div>

<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œçº¿ç¨‹å’Œ RunLoop ä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶å…³ç³»æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„ Dictionary é‡Œã€‚çº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰ RunLoopï¼Œå¦‚æœä½ ä¸ä¸»åŠ¨è·å–ï¼Œé‚£å®ƒä¸€ç›´éƒ½ä¸ä¼šæœ‰ã€‚RunLoop çš„åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶ï¼ŒRunLoop çš„é”€æ¯æ˜¯å‘ç”Ÿåœ¨çº¿ç¨‹ç»“æŸæ—¶ã€‚ä½ åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹çš„å†…éƒ¨è·å–å…¶ RunLoopï¼ˆä¸»çº¿ç¨‹é™¤å¤–ï¼‰ã€‚</p>

<p>RunLoopä¸çº¿ç¨‹ä¹‹é—´çš„å…³ç³»å¯†ä¸å¯åˆ†:</p>

<ol>
  <li>çº¿ç¨‹ä¸RunLoopæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªRunLoopå¯¹è±¡ï¼Œæ ¹RunLoopå¯ä»¥åµŒå¥—å­RunLoopã€‚</li>
  <li>ä¸»çº¿ç¨‹çš„RunLoopåœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œéä¸»çº¿ç¨‹çš„RunLoopéœ€è¦åœ¨è¯¥çº¿ç¨‹è‡ªå·±å¯åŠ¨ã€‚</li>
  <li></li>
</ol>

<h3 id="ä¸‰runloopç›¸å…³ç±»">ä¸‰ã€RunLoopç›¸å…³ç±»</h3>

:ET