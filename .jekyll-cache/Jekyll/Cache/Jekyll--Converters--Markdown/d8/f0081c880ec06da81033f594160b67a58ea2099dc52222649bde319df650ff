I"¸<<p>ä»å¾ˆå¤šå¹´å‰å¼€å§‹ï¼ŒCPU çš„é¢‘ç‡å¢é•¿å°±å‡ºç°åœæ»ï¼Œè½¬è€Œå‘å¤šæ ¸çš„æ–¹å‘å‘å±•ã€‚å¢åŠ æ ¸å¿ƒè¿œè¿œæ¯”æå‡åˆ¶ç¨‹ã€æ¶æ„è¦æ›´ç®€å•ã€‚å› æ­¤å¤šçº¿ç¨‹æŠ€æœ¯ä¹Ÿæœ‰ç€è¶Šæ¥è¶Šé‡è¦çš„åœ°ä½ã€‚</p>

<h3 id="ä¸€å¤šçº¿ç¨‹ç›¸å…³çŸ¥è¯†">ä¸€ã€å¤šçº¿ç¨‹ç›¸å…³çŸ¥è¯†</h3>

<h4 id="11-è¿›ç¨‹">1.1 è¿›ç¨‹</h4>

<ul>
  <li>è¿›ç¨‹æ˜¯æŒ‡åœ¨ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚åŒæ—¶æ‰“å¼€å¾®ä¿¡å’ŒXcodeï¼Œç³»ç»Ÿä¼šåˆ†åˆ«å¯åŠ¨2ä¸ªè¿›ç¨‹;</li>
  <li>æ¯ä¸ªè¿›ç¨‹ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¿›ç¨‹å‡è¿è¡Œåœ¨å…¶ä¸“ç”¨ä¸”å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´å†…ï¼›</li>
</ul>

<h4 id="12-çº¿ç¨‹">1.2 çº¿ç¨‹</h4>

<ul>
  <li>
    <p>ä¸€ä¸ªè¿›ç¨‹è¦æƒ³æ‰§è¡Œä»»åŠ¡ï¼Œå¿…é¡»å¾—æœ‰çº¿ç¨‹ï¼ˆæ¯ä¸€ä¸ªè¿›ç¨‹è‡³å°‘è¦æœ‰ä¸€æ¡çº¿ç¨‹)ï¼Œæ˜¯è¿›ç¨‹ä¸­æ‰§è¡Œè¿ç®—çš„æœ€å°å•ä½ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªå®ä½“ï¼Œæ˜¯è¢«ç³»ç»Ÿç‹¬ç«‹è°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½ï¼›</p>
  </li>
  <li>
    <p>ä¸€ä¸ªç¨‹åºæœ‰ä¸”åªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼ˆè°ƒç”¨<code class="highlighter-rouge">main</code>æ¥å¯åŠ¨ï¼‰ï¼Œä¸»çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯å’Œåº”ç”¨ç¨‹åºç»‘å®šï¼Œç¨‹åºé€€å‡ºæ—¶ï¼Œä¸»çº¿ç¨‹ä¹Ÿåœæ­¢ï¼›</p>
  </li>
</ul>

<h4 id="13-å¤šçº¿ç¨‹">1.3 å¤šçº¿ç¨‹</h4>

<ul>
  <li>æ¦‚å¿µï¼šä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¼€å¯å¤šæ¡çº¿ç¨‹ï¼Œæ¯ä¸€æ¡çº¿ç¨‹å¯ä»¥å¹¶è¡Œï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œä¸åŒçš„ä»»åŠ¡</li>
  <li>åŸç†ï¼šåŒä¸€æ—¶é—´ï¼ŒCPUåªèƒ½å¤„ç†ä¸€æ¡çº¿ç¨‹ï¼Œåªæœ‰ä¸€æ¡çº¿ç¨‹åœ¨å·¥ä½œï¼Œå¤šçº¿ç¨‹å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œï¼Œå…¶å®æ˜¯CPUå¿«é€Ÿçš„åœ¨å¤šæ¡çº¿ç¨‹ä¹‹é—´è°ƒåº¦ï¼ˆåˆ‡æ¢ï¼‰ï¼Œå¦‚æœCPUè°ƒåº¦çº¿ç¨‹çš„æ—¶é—´è¶³å¤Ÿå¿«ï¼Œå°±é€ æˆäº†å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„å‡è±¡</li>
  <li>æ³¨æ„ï¼šå¦‚æœçº¿ç¨‹å¾ˆå¤šï¼ŒCPUä¼šåœ¨Nå¤šçº¿ç¨‹ä¹‹é—´è°ƒåº¦ï¼Œä¼šæ¶ˆè€—å¤§é‡CPUèµ„æºï¼Œæ¯æ¡çº¿ç¨‹è¢«è°ƒåº¦æ‰§è¡Œçš„é¢‘æ¬¡ä¼šé™ä½ï¼ˆçº¿ç¨‹çš„æ‰§è¡Œæ•ˆç‡ä¼šé™ä½)</li>
</ul>

<h4 id="14-å¤šçº¿ç¨‹çš„ä¼˜ç¼ºç‚¹">1.4 å¤šçº¿ç¨‹çš„ä¼˜ç¼ºç‚¹</h4>

<ul>
  <li>
    <p>ä¼˜ç‚¹: èƒ½é€‚å½“çš„æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ä»¥åŠèµ„æºåˆ©ç”¨ç‡ï¼ˆCPUã€å†…å­˜åˆ©ç”¨ç‡ï¼‰</p>
  </li>
  <li>
    <p>ç¼ºç‚¹: æ¯åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ˜¯ä¼šå ç”¨èµ„æºçš„ï¼Œæ¯”å¦‚å†…å­˜å¼€é”€ç­‰ï¼›çº¿ç¨‹å¤ªå¤šï¼Œä¼šé™ä½ç¨‹åºçš„æ€§èƒ½ï¼› ç¨‹åºå¼€å‘å¤æ‚åº¦ä¸Šå‡</p>
  </li>
</ul>

<h4 id="15-ä¸»çº¿ç¨‹">1.5 ä¸»çº¿ç¨‹</h4>

<ul>
  <li>
    <p>ä¸€ä¸ªiOSç¨‹åºè¿è¡Œåï¼Œé»˜è®¤ä¼šå¼€å¯1æ¡çº¿ç¨‹ï¼Œç§°ä¸ºâ€œä¸»çº¿ç¨‹â€æˆ–â€œUIçº¿ç¨‹â€</p>
  </li>
  <li>
    <p>ä½œç”¨: æ˜¾ç¤ºï¼åˆ·æ–°UIç•Œé¢, å¤„ç†UIäº‹ä»¶ï¼ˆç‚¹å‡»äº‹ä»¶ï¼Œæ»šåŠ¨äº‹ä»¶ï¼Œæ‹–æ‹½äº‹ä»¶ï¼‰</p>
  </li>
  <li>
    <p>ä½¿ç”¨æ³¨æ„:ä¸è¦å°†è€—æ—¶çš„æ“ä½œæ”¾åˆ°ä¸»çº¿ç¨‹ä¸­ï¼Œè€—æ—¶æ“ä½œåº”æ”¾åœ¨å­çº¿ç¨‹ï¼ˆåå°çº¿ç¨‹ï¼Œéä¸»çº¿ç¨‹); å‡¡æ˜¯å’ŒUIç›¸å…³çš„æ“ä½œåº”æ”¾åœ¨ä¸»çº¿ç¨‹ä¸­æ“ä½œ</p>
  </li>
</ul>

<h4 id="16-iosä¸­å¤šçº¿ç¨‹çš„å®ç°æ–¹æ¡ˆ">1.6 iOSä¸­å¤šçº¿ç¨‹çš„å®ç°æ–¹æ¡ˆ</h4>

<ul>
  <li>pthread ï¼šä¸€å¥—é€šç”¨çš„å¤šçº¿ç¨‹APIï¼Œå¾ˆå°‘ç”¨åˆ°ï¼Œcè¯­è¨€ï¼Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç”±ç¨‹åºå‘˜ç®¡ç†ã€‚</li>
  <li>NSTreadï¼šocè¯­è¨€ï¼Œé¢å‘å¯¹è±¡ï¼Œç®€å•æ˜“ç”¨ï¼Œå¯ç›´æ¥æ“ä½œçº¿ç¨‹å¯¹è±¡ ï¼Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç”±ç¨‹åºå‘˜ç®¡ç†</li>
  <li>GCD:   å¸¸ç”¨ï¼Œæ›¿ä»£NSThreadç­‰çº¿ç¨‹æŠ€æœ¯ï¼Œå……åˆ†åˆ©ç”¨è®¾å¤‡çš„å¤šæ ¸ï¼Œcè¯­è¨€ï¼Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†</li>
  <li>NSOperation:  å¸¸ç”¨ï¼Œæ˜¯å¯¹GCDå°è£…ï¼Œä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡ï¼Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†</li>
</ul>

<h3 id="äºŒpthreads">äºŒã€Pthreads</h3>

<p>Pthreads æ˜¯POSIX å¤šçº¿ç¨‹å¼€å‘æ¡†æ¶ï¼Œæ˜¯è·¨å¹³å°çš„ C è¯­è¨€æ¡†æ¶,éœ€è¦è‡ªå·±ç®¡ç†çº¿ç¨‹çš„åˆ›å»ºé”€æ¯ç­‰æ“ä½œã€‚è¿™äº› API å…¨éƒ½ä»¥ <code class="highlighter-rouge">pthread_</code> ä½œä¸ºå‰ç¼€ã€‚iOS ä¸­ CFRunLoopå°±æ˜¯åŸºäºPthreadsæ¥ç®¡ç†çš„ã€‚æ›´åŠ è¯¦ç»†çš„å…³äº Pthreadsçš„å­¦ä¹ å¯ä»¥å‚è€ƒ <a href="https://computing.llnl.gov/tutorials/pthreads/">è¿™é‡Œ</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pthread_create()ï¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹
pthread_exit()ï¼šç»ˆæ­¢å½“å‰çº¿ç¨‹
pthread_cancel()ï¼šä¸­æ–­å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„è¿è¡Œ
pthread_join()ï¼šé˜»å¡å½“å‰çš„çº¿ç¨‹ï¼Œç›´åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿è¡Œç»“æŸ
pthread_attr_init()ï¼šåˆå§‹åŒ–çº¿ç¨‹çš„å±æ€§
pthread_attr_setdetachstate()ï¼šè®¾ç½®è„±ç¦»çŠ¶æ€çš„å±æ€§ï¼ˆå†³å®šè¿™ä¸ªçº¿ç¨‹åœ¨ç»ˆæ­¢æ—¶æ˜¯å¦å¯ä»¥è¢«ç»“åˆï¼‰
pthread_attr_getdetachstate()ï¼šè·å–è„±ç¦»çŠ¶æ€çš„å±æ€§
pthread_attr_destroy()ï¼šåˆ é™¤çº¿ç¨‹çš„å±æ€§
pthread_kill()ï¼šå‘çº¿ç¨‹å‘é€ä¸€ä¸ªä¿¡å·
pthread_equal(): å¯¹ä¸¤ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ ‡è¯†å·è¿›è¡Œæ¯”è¾ƒ
pthread_detach(): åˆ†ç¦»çº¿ç¨‹
pthread_self(): æŸ¥è¯¢çº¿ç¨‹è‡ªèº«çº¿ç¨‹æ ‡è¯†å·
...
</code></pre></div></div>

<h3 id="ä¸‰nsthread">ä¸‰ã€NSThread</h3>

<p>ä¸€ä¸ªNSThreadå¯¹è±¡å°±ä»£è¡¨ä¸€æ¡çº¿ç¨‹</p>

<h4 id="31--nsthreadå¸¸ç”¨æ–¹æ³•">3.1  NSThreadå¸¸ç”¨æ–¹æ³•</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// åˆ›å»ºã€å¯åŠ¨çº¿ç¨‹
NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(run) object:nil];
[thread start];

// åˆ›å»ºçº¿ç¨‹åè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹
[NSThread detachNewThreadSelector:@selector(run:) toTarget:self withObject:@"OC"];

// éšå¼åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹
[self performSelectorInBackground:@selector(run:) withObject:@"OC"];

// ä¸»çº¿ç¨‹ç›¸å…³ç”¨æ³•
[NSThread mainThread]; 		// è·å¾—ä¸»çº¿ç¨‹
[NSThread isMainThread]; 	// æ˜¯å¦ä¸ºä¸»çº¿ç¨‹
[thread isMainThread]; 		// æ˜¯å¦ä¸ºä¸»çº¿ç¨‹

// è·å¾—å½“å‰çº¿ç¨‹
NSThread *current = [NSThread currentThread];

// ä¼‘çœ çº¿ç¨‹
[NSThread sleepForTimeInterval:2];  //ä¼‘çœ 2s
[NSThread sleepUntilDate:[NSDate dateWithTimeIntervalSinceNow:2]]; //ä¼‘çœ 2s

// å¼ºåˆ¶é€€å‡ºçº¿ç¨‹ï¼Œä¸æ¨èä½¿ç”¨æ­¤æ–¹å¼é€€å‡ºå­çº¿ç¨‹,å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼
[NSThread exit];
</code></pre></div></div>

<h4 id="32--nsthreadåˆ›å»ºå¸¸é©»çº¿ç¨‹">3.2  NSThreadåˆ›å»ºå¸¸é©»çº¿ç¨‹</h4>

<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¢åŠ ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹å¸¸é©»RunLoopï¼Œé˜²æ­¢çº¿ç¨‹é€€å‡ºã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NSThread *runLoopThread = [[NSThread alloc] initWithTarget:self selector:@selector(onRunLoop) object:nil];
[runLoopThread start];
[self performSelector:@selector(dothingOnRunLoop:) onThread:runLoopThread withObject:@[@"å¸¸é©»RunLoopçº¿ç¨‹"] waitUntilDone:YES];

// å¸¸é©»runLoop
- (void)onRunLoop {
    @autoreleasepool {
        [NSThread currentThread].name = @"å¸¸é©»RunLoopçº¿ç¨‹";
        NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
        [runLoop addPort:[NSPort port] forMode:NSDefaultRunLoopMode];
        [runLoop run];
    }
}

// åœ¨runloopä¸Šæ‰§è¡Œæ“ä½œ
- (void)dothingOnRunLoop:(id)param {
    // å¯ä»¥åœ¨æ­¤æ‰“æ–­ç‚¹æµ‹è¯•çº¿ç¨‹æ˜¯å¦å·²ç»åŠ å…¥runloop
    NSLog(@"è·‘åœ¨runloopä¸Šçš„çº¿ç¨‹: %@", param);
}
</code></pre></div></div>

<h4 id="33-nsthreadçº¿ç¨‹é—´é€šè®¯">3.3 NSThreadçº¿ç¨‹é—´é€šè®¯</h4>

<p>NSThreadé€šè¿‡ä»¥ä¸‹å››ç§æ–¹å¼è¿›è¡Œçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// æŒ‡å®šæ–¹æ³•åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ, å‚æ•°1. SEL æ–¹æ³•  2.æ–¹æ³•å‚æ•°  3.æ˜¯å¦ç­‰å¾…å½“å‰æ‰§è¡Œå®Œæ¯• 4.æŒ‡å®šçš„Runloop model
- (void)performSelectorOnMainThread:(SEL)aSelector withObject:(nullable id)arg waitUntilDone:(BOOL)wait modes:(nullable NSArray&lt;NSString *&gt; *)array;
- (void)performSelectorOnMainThread:(SEL)aSelector withObject:(nullable id)arg waitUntilDone:(BOOL)wait;

// æŒ‡å®šæ–¹æ³•åœ¨æŸä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ, å‚æ•°1. SEL æ–¹æ³•  2.æ–¹æ³•å‚æ•° 3.æ˜¯å¦ç­‰å¾…å½“å‰æ‰§è¡Œå®Œæ¯• 4.æŒ‡å®šçš„Runloop model
- (void)performSelector:(SEL)aSelector onThread:(NSThread *)thr withObject:(nullable id)arg waitUntilDone:(BOOL)wait modes:(nullable NSArray&lt;NSString *&gt; *)array 
- (void)performSelector:(SEL)aSelector onThread:(NSThread *)thr withObject:(nullable id)arg waitUntilDone:(BOOL)wait 

// æŒ‡å®šæ–¹æ³•åœ¨å¼€å¯çš„å­çº¿ç¨‹ä¸­æ‰§è¡Œ, 1. SEL æ–¹æ³• 2.æ–¹æ³•å‚æ•°
- (void)performSelectorInBackground:(SEL)aSelector withObject:(nullable id)arg 
</code></pre></div></div>

<h3 id="å››gcd">å››ã€GCD</h3>

<p>æœ‰å…³GCDç›¸å…³å†…å®¹ï¼Œè¯·å‚è€ƒå¦ä¸€ç¯‡æ–‡ç«  <a href="[https://limeng99.club/learning/2019/11/20/%E5%85%B3%E4%BA%8EGCD%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF.html](https://limeng99.club/learning/2019/11/20/å…³äºGCDçš„é‚£äº›äº‹å„¿.html)">å…³äºGCDçš„é‚£äº›äº‹å„¿</a></p>

<h3 id="äº”nsoperationnsoperationqueue">äº”ã€NSOperationã€NSOperationQueue</h3>

<p>æœ‰å…³NSOperationã€NSOperationQueueç›¸å…³å†…å®¹ï¼Œè¯·å‚è€ƒå¦ä¸€ç¯‡æ–‡ç«  <a href="[https://limeng99.club/learning/2019/11/20/%E5%85%B3%E4%BA%8EGCD%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF.html](https://limeng99.club/learning/2019/11/22/iOSå¤šçº¿ç¨‹ï¼šNSOperationã€NSOperationQueueæ€»ç»“.html)">iOSå¤šçº¿ç¨‹ï¼šNSOperationã€NSOperationQueueæ€»ç»“</a></p>

<h3 id="å…­-å¤šçº¿ç¨‹çš„å®‰å…¨éšæ‚£">å…­ã€ å¤šçº¿ç¨‹çš„å®‰å…¨éšæ‚£</h3>

<p>ä¸€å—èµ„æºå¯èƒ½ä¼šè¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªçº¿ç¨‹å¯èƒ½ä¼šè®¿é—®åŒä¸€å—èµ„æºï¼›æˆ–è€…è¯´æ˜¯å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯¹è±¡ã€å˜é‡ã€æ–‡ä»¶ç­‰ç­‰ã€‚è¿™æ—¶å€™ï¼Œå¦‚æœä¸é‡‡å–ä¸€å®šçš„æªæ–½ï¼Œå¾ˆå®¹æ˜“å¼•å‘æ•°æ®é”™ä¹±å’Œæ•°æ®å®‰å…¨çš„é—®é¢˜ã€‚</p>

<h4 id="61-ioså¤šçº¿ç¨‹å®‰å…¨é—®é¢˜åŠæ–¹æ¡ˆ">6.1 iOSå¤šçº¿ç¨‹å®‰å…¨é—®é¢˜åŠæ–¹æ¡ˆ</h4>

<p>ä¸¾ä¸ªä¾‹å­ï¼Œé“¶è¡Œè´¦ç›®ä¸ŠåŸå…ˆæœ‰1000ï¼Œåœ¨å–é’±500çš„åŒæ—¶ï¼Œåˆå­˜é’±500ï¼Œè¿™æ—¶å€™å¤§å®¶ç¬¬ä¸€æ—¶é—´å°±æ˜¯è§‰å¾—ï¼Œè¿˜å‰©ä½™1000ï¼Œè¿™åªæ˜¯æ­£å¸¸ç°è±¡ï¼Œå¦‚æœå­˜å–æ“ä½œåŒæ—¶è¿›è¡Œçš„è¯ï¼Œå› ä¸ºåŸºç¡€éƒ½æ˜¯1000ï¼Œæ‰€ä»¥ï¼Œå–å®Œé’±å‰©ä½™500ï¼Œå­˜å®Œé’±å‰©ä½™1500ï¼Œè¿™ä¸¤ä¸ªæ•°æ®ä»»ä½•ä¸€ä¸ªæ”¾å›è´¦ç›®ä¸Šéƒ½æ˜¯ä¸æ­£ç¡®çš„ã€‚è¿™å°±æ˜¯å¤šæ¡çº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ªå¯¹è±¡æ‰€å¼•å‘çš„é—®é¢˜ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- (void)moneyTest {
    self.money = 100;
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    // å­˜é’±ä»»åŠ¡
    dispatch_async(queue, ^{
        for (int i = 0; i &lt; 10; i++) {
            [self __saveMoney];
        }
    });
    
    // å–é’±ä»»åŠ¡
    dispatch_async(queue, ^{
        for (int i = 0; i &lt; 10; i++) {
            [self __drawMoney];
        }
    });
}

// å­˜é’±
- (void)__saveMoney {
    int oldMoney = self.money;
    sleep(.2);
    oldMoney += 50;
    self.money = oldMoney;
    NSLog(@"å­˜50ï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}

// å–é’±
- (void)__drawMoney {
    int oldMoney = self.money;
    sleep(.2);
    oldMoney -= 20;
    self.money = oldMoney;
    NSLog(@"å–20ï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}

</code></pre></div></div>

<p>æœ€ç»ˆæ—¥å¿—ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2019-11-22 17:05:18.577892+0800 å¤šçº¿ç¨‹-demo[67341:21672333] å­˜50ï¼Œè¿˜å‰©440å…ƒ - &lt;NSThread: 0x600001807740&gt;{number = 6, name = (null)}
</code></pre></div></div>
<p>åœ¨æ­£å¸¸æµç¨‹ä¸‹ï¼Œæœ€åçš„ç»“æœæ˜¯é’±å‰©ä½™400ï¼Œç¥¨å‰©ä½™0ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œé’±æœ€ç»ˆçš„ç»“æœæ˜¯é”™çš„ï¼Œè¿™å°±æ˜¯å¤šçº¿ç¨‹åŒäº‹æ“ä½œåŒä¸€ä¸ªå¯¹è±¡æˆ–è€…æ–¹æ³•é€ æˆçš„éšæ‚£ã€‚è¿™ä¸ªï¼Œæˆ‘ä»¬è§£å†³é—®é¢˜çš„æ–¹æ¡ˆå°±æ˜¯ï¼šä½¿ç”¨çº¿ç¨‹åŒæ­¥æŠ€æœ¯ï¼ˆåŒæ­¥ï¼Œå°±æ˜¯ååŒæ­¥è°ƒï¼ŒæŒ‰é¢„å®šçš„å…ˆåæ¬¡åºè¿›è¡Œï¼‰ã€‚è€Œåœ¨iOSé¢†åŸŸä¸­ï¼Œå¸¸è§çš„çº¿ç¨‹åŒæ­¥æŠ€æœ¯å°±æ˜¯ï¼šåŠ é”ã€‚</p>

<p>å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬iOSçº¿ç¨‹åŒæ­¥æŠ€æœ¯çš„ä¸€äº›æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦åˆ†æçš„æ–¹æ¡ˆï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// æ€§èƒ½ä»é«˜åˆ°ä½æ’åº
os_unfair_lock
OSSpinLock
dispatch_semaphore
pthread_mutex
dispatch_queue(DISPATCH_QUEUE_SERIAL)
NSLock
NSCondition
NSRecursiveLock
NSConditionLock
@synchronized
</code></pre></div></div>

<h4 id="62-osspinlock">6.2 OSSpinLock</h4>

<p>ç¬¬ä¸€ç§OSSpinLockï¼Œè¿™ä¸ªæ–¹æ¡ˆå·²ç»è¢«è‹¹æœåºŸå¼ƒï¼Œå½“ç„¶ï¼Œç°åœ¨ä»ç„¶å¯ç”¨ï¼Œåªæ˜¯è‹¹æœä¸æ¨èä½¿ç”¨ã€‚OSSpinLockæ˜¯ä¸€ä¸ªè‡ªæ—‹é”ï¼Œé€šè¿‡åŠ é”è§£é”ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³å¤šçº¿ç¨‹éšæ‚£é—®é¢˜ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå­ç±»BLOSSpinLockDemoï¼Œç»§æ‰¿BLBaseDemo,ç„¶åå®šä¹‰ä¸ªé”ï¼Œåˆå§‹åŒ–å¯¹è±¡çš„åŒæ—¶å¯¹å®ƒä»¬è¿›è¡Œåˆå§‹åŒ–ã€‚ç„¶åé‡å†™å–ç¥¨å’Œå­˜å–é’±çš„æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­åŠ é”è§£é”ï¼š
@interface OSSpinLockDemo()

@property (assign, nonatomic) OSSpinLock moneyLock;

@end

@implementation OSSpinLockDemo

- (instancetype)init {
    if (self = [super init]) {
        self.moneyLock = OS_SPINLOCK_INIT;
    }
    return self;
}

- (void)__drawMoney {
    OSSpinLockLock(&amp;_moneyLock);
    
    [super __drawMoney];
    
    OSSpinLockUnlock(&amp;_moneyLock);
}

- (void)__saveMoney {
    OSSpinLockLock(&amp;_moneyLock);
    
    [super __saveMoney];
    
    OSSpinLockUnlock(&amp;_moneyLock);
}

@end

æœ€ç»ˆæ‰“å°ç»“æœå¦‚ä¸‹ï¼š
2019-11-22 17:10:18.577892+0800 å¤šçº¿ç¨‹-demo[67341:21672333] å­˜50ï¼Œè¿˜å‰©400å…ƒ - &lt;NSThread: 0x600001807740&gt;{number = 6, name = (null)}
é’±çš„ç»“æœæ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œå¹¶ä¸”æ˜¯æ­£ç¡®çš„ç»“æœ
</code></pre></div></div>

<h4 id="63-os_unfair_lock">6.3 os_unfair_lock</h4>

<p>OSSpinLockè‡ªæ—‹é”ä¼šå‡ºç°ä¸€ç§çŠ¶å†µï¼Œå½“ä¼˜å…ˆçº§ä½çš„çº¿ç¨‹åŠ é”ä¹‹åï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹åœ¨ç­‰å¾…çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‡ºç°ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šä¸€ç›´å ç€CPUèµ„æºï¼Œå¯¼è‡´ä¼˜å…ˆçº§ä½çš„çº¿ç¨‹æ²¡æ³•é‡Šæ”¾é”ï¼Œå‡ºç°çº¿ç¨‹æ­»é”çŠ¶æ€ã€‚è€Œäº’æ–¥é”è™½ç„¶åœ¨å”¤é†’çº¿ç¨‹çš„æ—¶å€™ä¼šæ¶ˆè€—CPUï¼Œä½†æ˜¯ä¸ä¼šå‡ºç°æ­»é”çŠ¶æ€ï¼Œç›¸å¯¹æ¯”è¾ƒå®‰å…¨ï¼Œæ‰€ä»¥ç›®å‰è‹¹æœä»iOS10å¼€å§‹å°±æ¨èå¤§å®¶ç”¨os_unfair_lockæ¥æ›¿æ¢OSSpinLockã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹os_unfair_lockçš„ä½¿ç”¨</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@interface OSUnfairLockDemo()

@property (assign, nonatomic) os_unfair_lock moneyLock;

@end

@implementation OSUnfairLockDemo

- (instancetype)init {
    if (self = [super init]) {
        self.moneyLock = OS_SPINLOCK_INIT;
    }
    return self;
}

- (void)__drawMoney {
    os_unfair_lock_lock(&amp;_moneyLock);
    
    [super __drawMoney];
    
    os_unfair_lock_unlock(&amp;_moneyLock);
}

- (void)__saveMoney {
    os_unfair_lock_lock(&amp;_moneyLock);
    
    [super __saveMoney];
    
    os_unfair_lock_unlock(&amp;_moneyLock);
}

@end

æœ€ç»ˆæ‰“å°ç»“æœå¦‚ä¸‹ï¼š
2019-11-22 17:13:18.577892+0800 å¤šçº¿ç¨‹-demo[67341:21672333] å–20ï¼Œè¿˜å‰©400å…ƒ - &lt;NSThread: 0x600001807740&gt;{number = 7, name = (null)}
</code></pre></div></div>

<h4 id="64-pthread_mutex">6.4 pthread_mutex</h4>

<p>pthread_mutexï¼Œcè¯­è¨€ç¼–å†™çš„é”ï¼Œä¹Ÿæ˜¯ä¸€ç§äº’æ–¥é”ã€‚å…ˆçœ‹çœ‹åŸºæœ¬çš„ä½¿ç”¨</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@interface MutexDemo()

@property (assign, nonatomic) pthread_mutex_t moneyLock;

@end

@implementation MutexDemo

- (void)initMutex:(pthread_mutex_t *)mutex {
    // åˆå§‹åŒ–å±æ€§
    pthread_mutexattr_t attr;
    pthread_mutexattr_init(&amp;attr);
    pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_DEFAULT);
    
    // åˆå§‹åŒ–mutex,å‚æ•°ä¸€æ˜¯pthread_mutex_t(é”) å‚æ•°äºŒæ˜¯pthread_mutexattr_t(å±æ€§)
    pthread_mutex_init(mutex, &amp;attr);
    //ä½¿ç”¨å®Œå±æ€§ä¹‹å è¦é”€æ¯
    pthread_mutexattr_destroy(&amp;attr);
}

- (instancetype)init {
    if (self = [super init]) {
        [self initMutex:&amp;_moneyLock];
    }
    return self;
}

- (void)__drawMoney {
    pthread_mutex_lock(&amp;_moneyLock);
    
    [super __drawMoney];
    
    pthread_mutex_unlock(&amp;_moneyLock);
}

- (void)__saveMoney {
    pthread_mutex_lock(&amp;_moneyLock);
    
    [super __saveMoney];
    
    pthread_mutex_unlock(&amp;_moneyLock);
}

@end

æœ€ç»ˆæ‰“å°ç»“æœå¦‚ä¸‹ï¼š
2019-11-22 17:18:18.577892+0800 å¤šçº¿ç¨‹-demo[67341:21672333] å–20ï¼Œè¿˜å‰©400å…ƒ - &lt;NSThread: 0x600001807740&gt;{number = 6, name = (null)}
</code></pre></div></div>

:ET