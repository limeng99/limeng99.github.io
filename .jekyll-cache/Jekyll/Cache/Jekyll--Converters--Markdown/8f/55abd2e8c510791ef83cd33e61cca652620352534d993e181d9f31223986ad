I">€<h2 id="1-é‡åˆ°çš„é—®é¢˜">1. é‡åˆ°çš„é—®é¢˜</h2>
<p>åœ¨é¡¹ç›®ä¸­ç»å¸¸ä¼šé‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼Œä¸€ä¸ªé¡µé¢ç”±äºå†…å®¹ç¹å¤šï¼Œç»“æ„å¤æ‚ï¼Œåå°å†™äº†5ä¸ªæ¥å£è¿›è¡Œæ”¯æŒï¼Œè¿™5ä¸ªæ¥å£äº’ç›¸åˆæ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œä¹Ÿæ²¡ä»€ä¹ˆé¡ºåºï¼Œä½†æ˜¯å°±æ˜¯éœ€è¦æŠŠè¿™5ä¸ªæ¥å£çš„æ•°æ®å…¨éƒ½æ‹¿åˆ°ä¹‹åç»„åˆä¸€ä¸‹ç„¶ååˆ·æ–°é¡µé¢ã€‚</p>

<p>ä»Šå¤©æˆ‘ä»¬ä¸»è¦æ¥è°ˆä¸€ä¸‹æ€ä¹ˆæ›´å¥½çš„ç”¨ç¬¬çš„æ–¹æ³•æ¥å®ç°ä¸Šè¿°éœ€æ±‚ï¼Œåœ¨iOSé‡Œé¢GCDæŠ€æœ¯æ­£å¥½å¯ä»¥è§£å†³è¿™ç§é—®é¢˜ï¼Œå½“ç„¶ä¹Ÿæœ‰å…¶ä»–æ–¹å¼ï¼Œåªæ˜¯GCDç”¨èµ·æ¥ä»£ç æ›´ç®€æ´ï¼Œå®ç°æ›´ä¼˜é›…ã€‚</p>

<h3 id="11-è§£å†³æ–¹æ³•">1.1 è§£å†³æ–¹æ³•</h3>
<p>è¯´åˆ°ç”¨GCDæ¥è§£å†³ï¼Œå…¶å®ä¹Ÿæœ‰å¾ˆå¤šè§£å†³æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥è¯´ä¸€ç§è§£å†³æ–¹æ³•</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//è·å–ä¸€ä¸‹ç³»ç»Ÿæä¾›çš„å…¨å±€é˜Ÿåˆ—
dispatch_queue_t queue =  dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);

//æ–°å»ºä¸€ä¸ªç»„
dispatch_group_t group = dispatch_group_create();

dispatch_group_async(group, queue, ^{
        
    //åˆ›å»ºä¸€ä¸ªè®¡æ•°ä¿¡å·Dispatch Semaphore åˆå§‹å€¼è®¾ä¸º0
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
        
    //å‘èµ·ç¬¬ä¸€ä¸ªç½‘ç»œè¯·æ±‚
    [Network GET:@"api" completion:^(id  _Nonnull result) {
        
        NSLog(@"ç½‘ç»œè¯·æ±‚1,æ‰§è¡Œå®Œæˆ");
        
        //å°†Dispatch Semaphoreè®¡æ•°ä¿¡å·å€¼åŠ 1 è¿™ä¸ªè¦å†™åˆ°ç½‘ç»œè¯·æ±‚çš„å›è°ƒé‡Œï¼Œæ— è®ºæˆåŠŸå¤±è´¥ã€‚
        dispatch_semaphore_signal(semaphore);

    }];
    
    //ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°Dispatch Semaphoreçš„è®¡æ•°å€¼è¾¾åˆ°å¤§äºç­‰äº1
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
});

.
.
. /* ä¸­é—´ä¸‰ä¸ªè¯·æ±‚æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œæ‰€ä»¥å°±å…ˆçœç•¥ã€‚ */
.
.

dispatch_group_async(group, queue, ^{
        
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
        
    //å‘èµ·ç¬¬5ä¸ªç½‘ç»œè¯·æ±‚ 
    [Network GET:@"api" completion:^(id  _Nonnull result) {
        NSLog(@"ç½‘ç»œè¯·æ±‚5,æ‰§è¡Œå®Œæˆ");
        dispatch_semaphore_signal(semaphore);
    }];
        
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
});

//å…¨éƒ¨æ‰§è¡Œç»“æŸ
dispatch_group_notify(group, queue, ^{
    NSLog(@"è¯·æ±‚å…¨éƒ¨æ‰§è¡Œç»“æŸ");
});

</code></pre></div></div>
<p>æ—¥å¿—è¾“å‡º</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2019-11-19 20:04:36.258363+0800 GCD-demo[8104:784197] ç½‘ç»œè¯·æ±‚3,æ‰§è¡Œå®Œæˆ
2019-11-19 20:04:36.258383+0800 GCD-demo[8104:784200] ç½‘ç»œè¯·æ±‚5,æ‰§è¡Œå®Œæˆ
2019-11-19 20:04:36.258418+0800 GCD-demo[8104:784198] ç½‘ç»œè¯·æ±‚1,æ‰§è¡Œå®Œæˆ
2019-11-19 20:04:36.258425+0800 GCD-demo[8104:784196] ç½‘ç»œè¯·æ±‚2,æ‰§è¡Œå®Œæˆ
2019-11-19 20:04:36.258429+0800 GCD-demo[8104:784199] ç½‘ç»œè¯·æ±‚4,æ‰§è¡Œå®Œæˆ
2019-11-19 20:04:36.258642+0800 GCD-demo[8104:784163] è¯·æ±‚å…¨éƒ¨æ‰§è¡Œç»“æŸ
</code></pre></div></div>

<p>ä»¥ä¸Šå°±æ˜¯GCDå¼‚æ­¥å¹¶å‘å®ç°äº”ä¸ªè¯·æ±‚çš„ä¸€ç§æ–¹æ³•ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬è§£é‡Šä¸€ä¸‹è¿™ç§æ–¹æ³•ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Œå®ç°åŸç†ï¼Œä»¥åŠå„ä¸ªGCDä¸­å‡½æ•°çš„å«ä¹‰åŠç”¨æ³•ã€‚</p>

<h2 id="2gcdçš„api">2.GCDçš„API</h2>

<h3 id="21-ä»€ä¹ˆæ˜¯dispatch-queue">2.1 ä»€ä¹ˆæ˜¯Dispatch Queue</h3>
<p>Dispatch Queueå°±æ˜¯æ‰§è¡Œå¤„ç†çš„ç­‰å¾…é˜Ÿåˆ—ã€‚ç¨‹åºçŒ¿ä»¬é€šè¿‡<code class="highlighter-rouge">dispatch_async</code>ç­‰ä¸€äº›å‡½æ•°APIåœ¨Blockä¸­å†™ä¸€äº›è‡ªå·±æƒ³æ‰§è¡Œçš„ä»£ç ï¼Œå¹¶è¿½åŠ çš„Dispatch Queueä¸­ã€‚ç„¶åDispatch QueueæŒ‰ç…§è¿½åŠ çš„é¡ºåºï¼ˆå­¦æœ¯ç”¨è¯­å…ˆè¿›å…ˆå‡ºFIFOï¼‰æ‰§è¡Œå¤„ç†ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_async(queue, ^
    //æƒ³è¦æ‰§è¡Œçš„å¤„ç†
});
</code></pre></div></div>
<p>æ‰§è¡Œå¤„ç†æ—¶å­˜åœ¨ä¸¤ç§Dispatch Queueï¼Œä¸€ç§æ˜¯ä¸²è¡Œé˜Ÿåˆ—Serial Dispatch Queueï¼Œä¸€ç§æ˜¯å¹¶è¡Œé˜Ÿåˆ—Concurrent Dispatch Queueã€‚</p>

<h3 id="22-å¦‚ä½•å¾—åˆ°ä¸€ä¸ªdispatch-queue">2.2. å¦‚ä½•å¾—åˆ°ä¸€ä¸ªDispatch Queue</h3>
<p>å¾—åˆ°Dispatch Queueæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯é€šè¿‡GCDçš„APIç”Ÿæˆï¼Œå¦ä¸€ç§æ˜¯è·å–ç³»ç»Ÿæ ‡å‡†æä¾›çš„Dispatch Queueã€‚</p>
<h4 id="221-é€šè¿‡gcdçš„apiç”Ÿæˆ">2.2.1 é€šè¿‡GCDçš„APIç”Ÿæˆ</h4>
<p>é€šè¿‡<code class="highlighter-rouge">dispatch_queue_create</code>å‡½æ•°å¯ç”ŸæˆDispatch Queueã€‚</p>
<ul>
  <li>ç”Ÿæˆä¸€ä¸ªSerial Dispatchä¸²è¡Œé˜Ÿåˆ—
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_queue_t mySerialDispatchQueue = dispatch_queue_create("mySerialDispacthQueue", NULL);
</code></pre></div>    </div>
    <p>è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šä¸²è¡Œé˜Ÿåˆ—çš„åç§°ï¼Œä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ï¼ŒDispatch Queueçš„åç§°æ¨èä½¿ç”¨åº”ç”¨ç¨‹åºçš„IDè¿™ç§é€†åºå…¨ç¨‹åŸŸåï¼Œè¿™æ ·å‘½åç®€å•æ˜“æ‡‚ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼Œã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥è®¾ä¸ºNULLï¼Œä½†è°ƒè¯•æ—¶å€™ä¸æ˜¯é‚£ä¹ˆæ–¹ä¾¿ã€‚ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šä¸ºNULL,å½“ç„¶ä½ ä¹Ÿå¯ä»¥è®¾DISPATCH_QUEUE_SERIALä¸è¿‡æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæœ¬èº«DISPATCH_QUEUE_SERIALå°±æ˜¯NULLï¼Œä¸ä¿¡çœ‹APIå•Šã€‚</p>
  </li>
  <li>ç”Ÿæˆä¸€ä¸ªConcurrent Dispatch Queue å¹¶è¡Œé˜Ÿåˆ—
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_queue_t myConcurrentDispatchQueue = dispatch_queue_create("myConcurrentDispatchQueue", DISPATCH_QUEUE_CONCURRENT);
</code></pre></div>    </div>
    <p>ç”Ÿæˆå¹¶è¡Œé˜Ÿåˆ—çš„æ—¶å€™ç¬¬ä¸€ä¸ªå‚æ•°åŒä¸Šï¼Œç¬¬äºŒä¸ªå‚æ•°å¿…é¡»å†™DISPATCH_QUEUE_CONCURRENTã€‚</p>
  </li>
</ul>

<h4 id="222-è·å–ç³»ç»Ÿæ ‡å‡†æä¾›çš„dispatch-queue">2.2.2 è·å–ç³»ç»Ÿæ ‡å‡†æä¾›çš„Dispatch Queue</h4>
<p>å®é™…ä¸Šå‘¢ï¼Œä¹Ÿä¸ç”¨ç‰¹æ„å»ç”ŸæˆDispatch Queueï¼Œç³»ç»Ÿä¼šç»™æˆ‘ä»¬æä¾›å‡ ä¸ªï¼Œæ¯”å¦‚Main Dispatch Queueå’ŒGlobal Dispatch Queueã€‚</p>

<p>Main Dispatch Queueæ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œå› ä¸ºä¸»çº¿ç¨‹åªæœ‰1ä¸ªï¼Œæ‰€ä»¥Main Dispatch Queueæ˜¯Serial Dispatch Queueä¸²è¡Œé˜Ÿåˆ—ã€‚</p>

<p>è€ŒGlobal Dispatch Queueæ˜¯æ‰€æœ‰åº”ç”¨ç¨‹åºéƒ½èƒ½ä½¿ç”¨çš„Concurrent Dispatch Queueï¼Œä¸€èˆ¬æ²¡å¿…è¦é€šè¿‡å‡½æ•°<code class="highlighter-rouge">dispatch_queue_create</code>é€ä¸ªç”ŸæˆConcurrent Dispatch Queueã€‚åªè¦è·å–ä¸€ä¸‹ç³»ç»Ÿæä¾›çš„Global Dispatch Queueä½¿ç”¨å³å¯ã€‚å¦å¤–å‘¢Global Dispatch Queueæœ‰4ä¸ªæ‰§è¡Œä¼˜å…ˆçº§ï¼Œåˆ†åˆ«æ˜¯é«˜ä¼˜å…ˆçº§ï¼ˆHigh Priorityï¼‰ã€é»˜è®¤ä¼˜å…ˆçº§ï¼ˆDefault Priorityï¼‰ã€ä½ä¼˜å…ˆçº§ï¼ˆLow Priorityï¼‰å’Œåå°ä¼˜å…ˆçº§ï¼ˆBackground Priorityï¼‰ã€‚</p>

<p>ç³»ç»Ÿæä¾›çš„Dispatch Queueç§ç±»å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">åç§°</th>
      <th style="text-align: left">ç§ç±»</th>
      <th style="text-align: left">è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Main Dispatch Queue</td>
      <td style="text-align: left">Serial Dispatch Queue</td>
      <td style="text-align: left">ä¸»çº¿ç¨‹æ‰§è¡Œ</td>
    </tr>
    <tr>
      <td style="text-align: left">Global Dispatch Queue(High Priority)</td>
      <td style="text-align: left">Concurrent Dispatch queue</td>
      <td style="text-align: left">æ‰§è¡Œä¼˜å…ˆçº§ï¼šé«˜ï¼ˆæœ€é«˜ä¼˜å…ˆï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left">Global Dispatch Queue(Default Priority)</td>
      <td style="text-align: left">Concurrent Dispatch queue</td>
      <td style="text-align: left">æ‰§è¡Œä¼˜å…ˆçº§ï¼šé»˜è®¤</td>
    </tr>
    <tr>
      <td style="text-align: left">Global Dispatch Queue(Low Priority)</td>
      <td style="text-align: left">Concurrent Dispatch queue</td>
      <td style="text-align: left">æ‰§è¡Œä¼˜å…ˆçº§ï¼šä½</td>
    </tr>
    <tr>
      <td style="text-align: left">Global Dispatch Queue(Background Priority)</td>
      <td style="text-align: left">Concurrent Dispatch queue</td>
      <td style="text-align: left">æ‰§è¡Œä¼˜å…ˆçº§ï¼šåå°</td>
    </tr>
  </tbody>
</table>

<p>å„ç§Dispatch Queue çš„è·å–æ–¹æ³•å¦‚ä¸‹ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Main Dispatch Queue çš„è·å–æ–¹æ³•
dispatch_queue_t mainDispatchQueue = dispatch_get_main_queue();

//  Global Dispatch Queue (æœ€é«˜ä¼˜å…ˆçº§)çš„è·å–æ–¹æ³•  
dispatch_queue_t globalDispatchQueueHigh = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0);
    
// Global Dispatch Queue (é»˜è®¤ä¼˜å…ˆçº§)çš„è·å–æ–¹æ³• 
dispatch_queue_t globalDispatchQueueDefault = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
// Global Dispatch Queue (ä½ä¼˜å…ˆçº§)çš„è·å–æ–¹æ³• 
dispatch_queue_t globalDispatchQueueLow = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, 0);
    
// Global Dispatch Queue (åå°ä¼˜å…ˆçº§)çš„è·å–æ–¹æ³• 
dispatch_queue_t globalDispatchQueueBackground = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0);
</code></pre></div></div>

<h4 id="223-gcdåŒæ­¥å’Œå¼‚æ­¥æ–¹æ³•">2.2.3 GCDåŒæ­¥å’Œå¼‚æ­¥æ–¹æ³•</h4>

<ul>
  <li>åŒæ­¥æ“ä½œ</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_sync(&lt;#dispatch_queue_t  _Nonnull queue#&gt;, &lt;#^(void)block#&gt;)
</code></pre></div></div>

<ul>
  <li>å¼‚æ­¥æ“ä½œ</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_async(&lt;#dispatch_queue_t  _Nonnull queue#&gt;, &lt;#^(void)block#&gt;)
</code></pre></div></div>

<h4 id="224-ä¸²è¡Œå¹¶è¡Œé˜Ÿåˆ—å’ŒåŒæ­¥å¼‚æ­¥ç»“åˆåˆ†æ">2.2.4 ä¸²è¡Œã€å¹¶è¡Œé˜Ÿåˆ—å’ŒåŒæ­¥ã€å¼‚æ­¥ç»“åˆåˆ†æ</h4>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Â </th>
      <th style="text-align: center">dispatch_sync</th>
      <th style="text-align: center">dispatch_async</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">ä¸²è¡Œé˜Ÿåˆ—</td>
      <td style="text-align: center">ä¸å¼€å¯æ–°çº¿ç¨‹,åœ¨å½“å‰çº¿ç¨‹æŒ‰åºæ‰§è¡Œä»»åŠ¡</td>
      <td style="text-align: center">å¼€å¯ä¸€æ¡æ–°çš„çº¿ç¨‹ï¼Œæ–°åˆ›å»ºçš„çº¿ç¨‹ä¸­ä»»åŠ¡æ˜¯ä¸²è¡Œçš„</td>
    </tr>
    <tr>
      <td style="text-align: center">ä¸»é˜Ÿåˆ—</td>
      <td style="text-align: center">ä¸å¼€å¯æ–°çº¿ç¨‹,åœ¨ä¸»çº¿çº¿ç¨‹æŒ‰åºæ‰§è¡Œä»»åŠ¡;<code class="highlighter-rouge">å¦‚æœåœ¨ä¸»çº¿ç¨‹ä½¿ç”¨è¿™ç§ç»„åˆä¼šæ­»é”</code></td>
      <td style="text-align: center">ä¸å¼€å¯æ–°çº¿ç¨‹,åœ¨ä¸»çº¿çº¿ç¨‹æŒ‰åºæ‰§è¡Œä»»åŠ¡</td>
    </tr>
    <tr>
      <td style="text-align: center">å¹¶å‘ / å…¨å±€å¹¶å‘é˜Ÿåˆ—</td>
      <td style="text-align: center">ä¸å¼€å¯æ–°çº¿ç¨‹,åœ¨å½“å‰çº¿ç¨‹æŒ‰åºæ‰§è¡Œä»»åŠ¡</td>
      <td style="text-align: center">å¯ä»¥åŒæ—¶å¼€å¯å¤šæ¡çº¿ç¨‹,ä»»åŠ¡æ˜¯å¹¶å‘æ‰§è¡Œçš„,å…·ä½“å¼€å¯å¤šå°‘æ¡çº¿ç¨‹æœ‰GCDè‡ªåŠ¨æ ¹æ®CPUæƒ…å†µå†³å®š</td>
    </tr>
  </tbody>
</table>

<h3 id="23-dispatch-group">2.3 Dispatch Group</h3>

<p>Dispatch Groupå°±æ˜¯æˆ‘ä»¬åˆšå¼€å§‹æŠ›å‡ºçš„é—®é¢˜è§£å†³æ–¹æ¡ˆä¸­çš„ä¸»è¦å‡½æ•°ï¼Œå…¶ä½œç”¨å°±æ˜¯æŠŠå¹¶å‘çš„å‡ ä¸ªé˜Ÿåˆ—Dispatch Queueä»»åŠ¡åŠ åˆ°ç»„é‡Œï¼Œç„¶åè°ƒç”¨<code class="highlighter-rouge">dispatch_group_notify</code>æˆ–è€…<code class="highlighter-rouge">dispatch_group_wait</code>ç›‘å¬ç»“æŸã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//è·å–ä¸€ä¸‹ç³»ç»Ÿæä¾›çš„å…¨å±€é˜Ÿåˆ—
dispatch_queue_t queue =  dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
//æ–°å»ºä¸€ä¸ªç»„
dispatch_group_t group = dispatch_group_create();

dispatch_group_async(group, queue, ^{
    NSLog(@"ç¬¬1ä¸ªä»»åŠ¡");
});

dispatch_group_async(group, queue, ^{
    NSLog(@"ç¬¬2ä¸ªä»»åŠ¡");
});

dispatch_group_async(group, queue, ^{
    NSLog(@"ç¬¬3ä¸ªä»»åŠ¡");
});

dispatch_group_async(group, queue, ^{
    NSLog(@"ç¬¬4ä¸ªä»»åŠ¡");
});

//å…¨éƒ¨æ‰§è¡Œç»“æŸ
dispatch_group_notify(group, queue, ^{
    NSLog(@"è¯·æ±‚å…¨éƒ¨æ‰§è¡Œç»“æŸ");
});    
</code></pre></div></div>

<p>è¾“å‡ºæ—¥å¿—</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2019-11-19 19:50:12.347291+0800 GCD-demo[7994:761684] ç¬¬2ä¸ªä»»åŠ¡
2019-11-19 19:50:12.347291+0800 GCD-demo[7994:761686] ç¬¬3ä¸ªä»»åŠ¡
2019-11-19 19:50:12.347292+0800 GCD-demo[7994:761683] ç¬¬1ä¸ªä»»åŠ¡
2019-11-19 19:50:12.347317+0800 GCD-demo[7994:761685] ç¬¬4ä¸ªä»»åŠ¡
2019-11-19 19:50:12.347453+0800 GCD-demo[7994:761685] è¯·æ±‚å…¨éƒ¨æ‰§è¡Œç»“æŸ
</code></pre></div></div>
<p>å› ä¸ºæƒ³Global Dispatch Queueå³Concurrent Dispatch Queueè¿½åŠ å¤„ç†ï¼Œå¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥è¿½åŠ å¤„ç†çš„æ‰§è¡Œé¡ºåºä¸å®šã€‚æ‰§è¡Œæ—¶ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯æ‰§è¡Œç»“æœä¸€å®šæ˜¯æœ€åè¾“å‡ºçš„ã€‚</p>

<p>æ— è®ºæƒ³ä»€ä¹ˆæ ·çš„Dispatch Queueä¸­è¿½åŠ å¤„ç†ï¼Œä½¿ç”¨Dispatch Groupéƒ½å¯ä»¥ç›‘è§†è¿™äº›å¤„ç†æ‰§è¡Œçš„ç»“æŸã€‚ä¸€æ—¦æ£€æµ‹åˆ°æ‰€æœ‰çš„å¤„ç†æ‰§è¡Œç»“æŸï¼Œå°±å¯å°†ç»“æŸçš„å¤„ç†è¿½åŠ åˆ°Dispatch Queueä¸­ã€‚è¿™å°±æ˜¯ä½¿ç”¨Dispatch Groupçš„åŸå› æ‰€åœ¨ã€‚</p>

<p>ä¸‹é¢ç®€å•è§£é‡Šä¸€ä¸‹ä¸Šé¢ä»£ç çš„å«ä¹‰ï¼Œé¦–å…ˆ<code class="highlighter-rouge">dispatch_group_create</code>å‡½æ•°ç”Ÿæˆ<code class="highlighter-rouge">dispatch_group_t</code>ç±»å‹çš„Dispatch Groupã€‚ç„¶åè°ƒç”¨<code class="highlighter-rouge">dispatch_group_async</code>å‡½æ•°è¿½åŠ å¤„ç†ï¼Œæœ€åç”¨<code class="highlighter-rouge">dispatch_group_notify</code>ç›‘è§†å¤„ç†æ‰§è¡Œçš„ç»“æŸã€‚<code class="highlighter-rouge">dispatch_group_async</code>ä¸Dispatch Queueçš„<code class="highlighter-rouge">dispatch_async</code>å‡½æ•°ä½œç”¨ç›¸åŒï¼Œéƒ½æ˜¯å°†Blockçš„ä»£ç è¿½åŠ åˆ°Dispatch Queueä¸­ã€‚ä¸åŒç‚¹æ˜¯<code class="highlighter-rouge">dispatch_group_async</code>éœ€è¦å°†æŒ‡å®šçš„Dispatch Groupä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚<code class="highlighter-rouge">dispatch_group_notify</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å®šè¦ç›‘è§†çš„Dispatch Groupã€‚åœ¨è¿½åŠ åˆ°è¯¥Dispatch Groupçš„å…¨éƒ¨å¤„ç†æ‰§è¡Œç»“æŸçš„æ—¶å€™ï¼Œå°†ç¬¬ä¸‰ä¸ªå‚æ•°çš„Blockè¿½åŠ åˆ°ç¬¬äºŒä¸ªå‚æ•°çš„Dispatch Queueä¸­ã€‚</p>

<p>å½“ç„¶ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¹Ÿä¸æ˜¯å¿…é¡»æ˜¯<code class="highlighter-rouge">dispatch_group_async</code>å‡½æ•°ä¸­çš„Dispatch Queueï¼Œå¯ä»¥æ˜¯ä»»æ„çš„Dispatch Queueã€‚Dispatch Groupè¿˜æœ‰ä¸€ä¸ªç›‘è§†ç»“æŸçš„å‡½æ•°<code class="highlighter-rouge">dispatch_group_wait</code>,è¿™ä¸ªå‡½æ•°éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯è¦ç›‘è§†çš„Dispatch Group,å¦ä¸€ä¸ªæ˜¯ç­‰å¾…æ—¶é—´ã€‚</p>

<h3 id="24-dispatch-semaphore">2.4 Dispatch Semaphore</h3>
<p>GCDå‡½æ•°Dispatch Semaphoreä¿¡å·é‡ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//åˆ›å»ºä¿¡å·é‡ï¼Œå‚æ•°ï¼šä¿¡å·é‡çš„åˆå€¼ï¼Œå¦‚æœå°äº0åˆ™ä¼šè¿”å›NULL
dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);

//ç­‰å¾…é™ä½ä¿¡å·é‡ï¼Œç­‰å¾…æ—¶é—´ä¸ºDISPATCH_TIME_FOREVERæ—¶å³æ°¸ä¹…ï¼Œç›´åˆ°ä¿¡å·é‡å¤§äºæˆ–ç­‰äº1ï¼Œå‡½æ•°ä¼šå¯¹ä¿¡å·é‡çš„å€¼è¿›è¡Œå‡1æ“ä½œï¼Œç„¶åè¿”å›
dispatch_semaphore_waitï¼ˆä¿¡å·é‡ï¼Œç­‰å¾…æ—¶é—´ï¼‰

//ä¿¡å·é‡åŠ 1
dispatch_semaphore_signal(ä¿¡å·é‡)
</code></pre></div></div>
<p>ç”ŸæˆDispatch Semaphoreéœ€è¦ä¸€ä¸ªåˆå§‹å€¼ï¼Œè¿™ä¸ªåˆå§‹å€¼å°±æ˜¯ä¿¡å·é‡æ•°å€¼ã€‚</p>

<h4 id="241-dispatch_semaphore_tåˆ›å»ºå¤šçº¿ç¨‹ç½‘ç»œåŒæ­¥è¯·æ±‚">2.4.1 dispatch_semaphore_tåˆ›å»ºå¤šçº¿ç¨‹ç½‘ç»œåŒæ­¥è¯·æ±‚</h4>

<p>æˆ‘ä»¬ç”¨ä¸€å¼€å§‹æ–‡ç« å¼€å¤´æŠ›å‡ºçš„é—®é¢˜æ¥è¯´ä¸€ä¸‹è¿™ä¸ªDispatch Semaphoreçš„ç”¨æ³•ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_group_async(group, queue, ^{

    //åˆ›å»ºä¸€ä¸ªDispatch Semaphoreåˆå§‹å€¼ä¸º0    
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
    
    //å‘èµ·ç½‘ç»œè¯·æ±‚
    [Network GET:@"api" completion:^(id  _Nonnull result) {
        NSLog(@"ç½‘ç»œè¯·æ±‚å®Œæˆ");
        //ä¿¡å·é‡åŠ 1
        dispatch_semaphore_signal(semaphore);
    }];

    //ç­‰å¾…Dispatch Semaphoreçš„è®¡æ•°å€¼è¾¾åˆ°å¤§äºæˆ–è€…ç­‰äº1
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
});
</code></pre></div></div>
<p>é¦–å…ˆæˆ‘ä»¬å…ˆæƒ³ä¸€ä¸‹ï¼Œå¦‚æœ<strong>è¿™ä¸ªä¾‹å­ä¸å†™Dispatch Semaphore</strong>ä¼šæ€ä¹ˆæ ·ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¾“å‡ºæ—¥å¿—ã€‚</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2019-11-19 20:53:40.277849+0800 GCD-demo[8633:900152] è¯·æ±‚å…¨éƒ¨æ‰§è¡Œç»“æŸ
2019-11-19 20:53:50.277986+0800 GCD-demo[8633:900129] ç½‘ç»œè¯·æ±‚1,æ‰§è¡Œå®Œæˆ
2019-11-19 20:53:50.277993+0800 GCD-demo[8633:900127] ç½‘ç»œè¯·æ±‚2,æ‰§è¡Œå®Œæˆ
2019-11-19 20:53:50.277996+0800 GCD-demo[8633:900151] ç½‘ç»œè¯·æ±‚5,æ‰§è¡Œå®Œæˆ
2019-11-19 20:53:50.278000+0800 GCD-demo[8633:900130] ç½‘ç»œè¯·æ±‚4,æ‰§è¡Œå®Œæˆ
2019-11-19 20:53:50.278008+0800 GCD-demo[8633:900128] ç½‘ç»œè¯·æ±‚3,æ‰§è¡Œå®Œæˆ
</code></pre></div></div>
<p>å‡ºç°ä¸Šé¢çš„æƒ…å†µï¼Œ<code class="highlighter-rouge">dispatch_group_notify</code>ç›‘è§†åˆ°æ•´ä¸ªDispatch Groupå·²ç»ç»“æŸï¼Œç„¶è€Œï¼Œç½‘ç»œè¯·æ±‚è¿˜æ²¡æœ‰å®Œæˆã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¿¡å·ï¼Œå‘Šè¯‰<code class="highlighter-rouge">dispatch_group_async</code>å‡½æ•°ï¼Œä»€ä¹ˆæ—¶å€™æ‰æ˜¯çœŸæ­£çš„å®Œæˆçš„æ‰§è¡Œå¤„ç†ã€‚</p>

<p>Dispatch Semaphoreæ­£å¥½å°±æ˜¯å¹²è¿™ä¸ªäº‹æƒ…çš„ï¼Œæˆ‘ä»¬å…ˆå£°æ˜ä¸€ä¸ªDispatch Semaphoreï¼Œåˆå§‹å€¼å°±æ˜¯0ï¼Œç„¶åæ‰§è¡Œ<code class="highlighter-rouge">dispatch_semaphore_wait</code>å‡½æ•°ï¼Œ<code class="highlighter-rouge">dispatch_semaphore_wait</code>å‡½æ•°éœ€è¦ä¸¤ä¸ªå…¥å‚ï¼Œåˆ†åˆ«æ˜¯ç­‰å¾…çš„Dispatch Semaphoreè¿˜æœ‰ç­‰å¾…æ—¶é—´ã€‚Dispatch Semaphoreåœ¨è®¾å®šçš„ç­‰å¾…æ—¶é—´å†…æ£€æµ‹åˆ°ä¿¡å·é‡å°äº1ï¼Œå°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°ç½‘ç»œè¯·æ±‚å®Œæˆï¼Œ<code class="highlighter-rouge">dispatch_semaphore_signal</code>å‡½æ•°æŠŠä¿¡å·é‡çš„å€¼åŠ 1ï¼Œä½¿å…¶Dispatch Semaphoreçš„è®¡æ•°å€¼è¾¾åˆ°å¤§äºç­‰äº1ï¼Œæˆ–è€…è¶…æ—¶ã€‚è¾¾åˆ°å…¶ä¸­ä¸€ä¸ªæ¡ä»¶å°±ä¼šå‘Šè¯‰<code class="highlighter-rouge">dispatch_group_async</code>å‡½æ•°æ­¤æ¬¡æ‰§è¡Œå¤„ç†å®Œæˆã€‚</p>

<h4 id="242-dispatch_semaphore_tè®¾ç½®æœ€å¤§å¹¶å‘æ•°">2.4.2 dispatch_semaphore_tè®¾ç½®æœ€å¤§å¹¶å‘æ•°</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//è·å–ä¸€ä¸‹ç³»ç»Ÿæä¾›çš„å…¨å±€é˜Ÿåˆ—DISPATCH_QUEUE_CONCURRENT ç”Ÿæˆä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—
dispatch_queue_t queue = dispatch_queue_create("myConcurrentDispatchQueue", DISPATCH_QUEUE_CONCURRENT);

//åˆ›å»ºä¸€ä¸ªDispatch Semaphoreåˆå§‹å€¼ä¸º2
dispatch_semaphore_t semaphore = dispatch_semaphore_create(2);

//æ–°å»ºä¸€ä¸ªç»„
dispatch_group_t group = dispatch_group_create();
 
for (int i = 0; i &lt; 10; i++) {
    dispatch_group_async(group, queue, ^{
    		dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
    		
    		// çº¿ç¨‹æ“ä½œåŒºåŸŸ æœ€å¤šæœ‰ä¸¤ä¸ªçº¿ç¨‹åœ¨æ­¤å·¥ä½œ
    		
    		dispatch_semaphore_signal(semaphore);
    });
}

//å…¨éƒ¨æ‰§è¡Œç»“æŸ
dispatch_group_notify(group, queue, ^{
    NSLog(@"å…¨éƒ¨æ‰§è¡Œç»“æŸ");
});
</code></pre></div></div>

<p>é€šè¿‡è®¾ç½®<code class="highlighter-rouge">dispatch_semaphore_create</code>å‚æ•°ä¸º2ï¼Œåˆ©ç”¨Dispatch Semaphoreçš„ç‰¹æ€§<code class="highlighter-rouge">dispatch_semaphore_wait</code>ä¸<code class="highlighter-rouge">dispatch_semaphore_signal</code>ä¹‹é—´æœ€å¤šæœ‰ä¸¤ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Œä»è€Œè¾¾åˆ°è®¾ç½®é˜Ÿåˆ—çš„æœ€å¤§å¹¶å‘æ•°çš„ç›®çš„ã€‚</p>

<h3 id="25-dispatch-barrier">2.5 Dispatch Barrier</h3>

<p>æ …æ å‡½æ•°ï¼Œç­‰å¾…åœ¨Dispatch Barrierå‰é¢æ’å…¥é˜Ÿåˆ—çš„ä»»åŠ¡å…ˆæ‰§è¡Œå®Œï¼Œå†æ‰§è¡Œåé¢çš„ä»»åŠ¡ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// queue: å°†barrieræ·»åŠ åˆ°çš„é˜Ÿåˆ— , block: barrieræ‰§è¡Œçš„ä»»åŠ¡
void dispatch_barrier_sync(dispatch_queue_t queue, dispatch_block_t block);
void dispatch_barrier_async(dispatch_queue_t queue, dispatch_block_t block);
</code></pre></div></div>

<h4 id="251-dispatch_barrier_sync">2.5.1 dispatch_barrier_sync</h4>

<p>dispatch_barrier_syncå°†è‡ªå·±çš„ä»»åŠ¡æ’å…¥åˆ°é˜Ÿåˆ—çš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾…è‡ªå·±çš„ä»»åŠ¡ç»“æŸä¹‹åæ‰ä¼šç»§ç»­æ’å…¥è¢«å†™åœ¨å®ƒåé¢çš„ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œå®ƒä»¬ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// åˆ›å»ºConcurrent Dispatch Queue å¹¶è¡Œé˜Ÿåˆ—
dispatch_queue_t concurrentQueue = dispatch_queue_create("concurrentQueue", DISPATCH_QUEUE_CONCURRENT);

// å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡
dispatch_async(concurrentQueue, ^{
   NSLog(@"ç¬¬1ä¸ªä»»åŠ¡");
});

dispatch_async(concurrentQueue, ^{
   NSLog(@"ç¬¬2ä¸ªä»»åŠ¡");
});

// dispatch_barrier_sync æ·»åŠ ä»»åŠ¡
dispatch_barrier_sync(concurrentQueue, ^{
    sleep(1);
   NSLog(@"Dispatch Barrierä»»åŠ¡");
});

NSLog(@"ä¸»çº¿ç¨‹ä»»åŠ¡1");

dispatch_async(concurrentQueue, ^{
    NSLog(@"ç¬¬3ä¸ªä»»åŠ¡");
});

dispatch_async(concurrentQueue, ^{
    NSLog(@"ç¬¬4ä¸ªä»»åŠ¡");
});

NSLog(@"ä¸»çº¿ç¨‹ä»»åŠ¡2");
</code></pre></div></div>

<p>è¾“å‡ºæ—¥å¿—</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2019-11-20 17:58:13.737806+0800 GCD-demo[51368:20064429] ç¬¬1ä¸ªä»»åŠ¡
2019-11-20 17:58:13.737831+0800 GCD-demo[51368:20064430] ç¬¬2ä¸ªä»»åŠ¡
2019-11-20 17:58:14.739234+0800 GCD-demo[51368:20064366] Dispatch Barrierä»»åŠ¡
2019-11-20 17:58:14.739529+0800 GCD-demo[51368:20064366] ä¸»çº¿ç¨‹ä»»åŠ¡1
2019-11-20 17:58:14.739739+0800 GCD-demo[51368:20064366] ä¸»çº¿ç¨‹ä»»åŠ¡2
2019-11-20 17:58:14.739773+0800 GCD-demo[51368:20064430] ç¬¬3ä¸ªä»»åŠ¡
2019-11-20 17:58:14.739778+0800 GCD-demo[51368:20064429] ç¬¬4ä¸ªä»»åŠ¡
</code></pre></div></div>

<p>ç”±æ­¤å¯è§ï¼Œ<code class="highlighter-rouge">dispatch_barrier_sync</code>å¿…é¡»ç­‰å¾…è‡ªå·±ä»»åŠ¡ç»“æŸï¼Œæ‰ä¼šæŠŠåç»­ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œç„¶åæ‰§è¡Œå®ƒä»¬ã€‚</p>

<h4 id="252-dispatch_barrier_async">2.5.2 dispatch_barrier_async</h4>

<p>dispatch_barrier_asyncå°†è‡ªå·±çš„ä»»åŠ¡æ’å…¥åˆ°é˜Ÿåˆ—ä¹‹åï¼Œä¸ä¼šç­‰å¾…è‡ªå·±çš„ä»»åŠ¡ç»“æŸï¼Œå®ƒä¼šç»§ç»­æŠŠåé¢çš„ä»»åŠ¡æ’å…¥åˆ°é˜Ÿåˆ—ï¼Œç„¶åç­‰å¾…è‡ªå·±çš„ä»»åŠ¡ç»“æŸåæ‰æ‰§è¡Œåé¢ä»»åŠ¡ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// åˆ›å»ºConcurrent Dispatch Queue å¹¶è¡Œé˜Ÿåˆ—
dispatch_queue_t concurrentQueue = dispatch_queue_create("concurrentQueue", DISPATCH_QUEUE_CONCURRENT);

// å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡
dispatch_async(concurrentQueue, ^{
   NSLog(@"ç¬¬1ä¸ªä»»åŠ¡");
});

dispatch_async(concurrentQueue, ^{
   NSLog(@"ç¬¬2ä¸ªä»»åŠ¡");
});

// dispatch_barrier_async æ·»åŠ ä»»åŠ¡
dispatch_barrier_async(concurrentQueue, ^{
    sleep(1);
   NSLog(@"Dispatch Barrierä»»åŠ¡");
});

NSLog(@"ä¸»çº¿ç¨‹ä»»åŠ¡1");

dispatch_async(concurrentQueue, ^{
    NSLog(@"ç¬¬3ä¸ªä»»åŠ¡");
});

dispatch_async(concurrentQueue, ^{
    NSLog(@"ç¬¬4ä¸ªä»»åŠ¡");
});

NSLog(@"ä¸»çº¿ç¨‹ä»»åŠ¡2");
</code></pre></div></div>

<p>è¾“å‡ºæ—¥å¿—</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2019-11-20 17:54:05.535233+0800 GCD-demo[51346:20058026] ä¸»çº¿ç¨‹ä»»åŠ¡1
2019-11-20 17:54:05.535251+0800 GCD-demo[51346:20058062] ç¬¬1ä¸ªä»»åŠ¡
2019-11-20 17:54:05.535263+0800 GCD-demo[51346:20058060] ç¬¬2ä¸ªä»»åŠ¡
2019-11-20 17:54:05.535402+0800 GCD-demo[51346:20058026] ä¸»çº¿ç¨‹ä»»åŠ¡2
2019-11-20 17:54:06.539084+0800 GCD-demo[51346:20058060] Dispatch Barrierä»»åŠ¡
2019-11-20 17:54:06.539451+0800 GCD-demo[51346:20058062] ç¬¬4ä¸ªä»»åŠ¡
2019-11-20 17:54:06.539438+0800 GCD-demo[51346:20058060] ç¬¬3ä¸ªä»»åŠ¡
</code></pre></div></div>

<p>ç”±æ­¤å¯è§ï¼Œ<code class="highlighter-rouge">dispatch_barrier_async</code>ä¸ä¼šæ‹¦æˆªåç»­ä»»åŠ¡åŠ è½½åˆ°é˜Ÿåˆ—ï¼Œä½†åç»­ä»»åŠ¡å¿…é¡»ç­‰å¾…<code class="highlighter-rouge">dispatch_barrier_async</code>ä»»åŠ¡æ‰§è¡Œç»“æŸï¼Œåç»­ä»»åŠ¡æ‰å¯æ‰§è¡Œ</p>

<h3 id="26-dispatch-source">2.6 Dispatch Source</h3>

<p>GCDä¸­é™¤äº†ä¸»è¦çš„ <code class="highlighter-rouge">Dispatch Queue</code> å¤–ï¼Œè¿˜æœ‰ä¸å¤ªå¼•äººæ³¨ç›®çš„ <code class="highlighter-rouge">Dispatch Source</code> ã€‚ä½¿ç”¨ <code class="highlighter-rouge">Dispatch Source</code>è€Œä¸ä½¿ç”¨ <code class="highlighter-rouge">Dispatch Queue</code>å”¯ä¸€åŸå› å°±æ˜¯åˆ©ç”¨è”ç»“çš„ä¼˜åŠ¿ã€‚</p>

<p>è”ç»“çš„å¤§è‡´æµç¨‹ï¼šåœ¨ä»»ä¸€çº¿ç¨‹ä¸Šè°ƒç”¨å®ƒçš„çš„ä¸€ä¸ªå‡½æ•° <code class="highlighter-rouge">dispatch_source_merge_data</code> åï¼Œä¼šæ‰§è¡Œ <code class="highlighter-rouge">Dispatch Source</code> äº‹å…ˆå®šä¹‰å¥½çš„å¥æŸ„ï¼ˆå¯ä»¥æŠŠå¥æŸ„ç®€å•ç†è§£ä¸ºä¸€ä¸ª block ï¼‰ã€‚</p>

<p>è¿™ä¸ªè¿‡ç¨‹å« <code class="highlighter-rouge">Custom event</code> ,ç”¨æˆ·äº‹ä»¶ã€‚æ˜¯ dispatch source æ”¯æŒå¤„ç†çš„ä¸€ç§äº‹ä»¶ã€‚</p>

<blockquote>
  <p>ç®€å•åœ°è¯´ï¼Œè¿™ç§äº‹ä»¶æ˜¯ç”±ä½ è°ƒç”¨ <code class="highlighter-rouge">dispatch_source_merge_data</code> å‡½æ•°æ¥å‘è‡ªå·±å‘å‡ºçš„ä¿¡å·ã€‚</p>
</blockquote>

<h4 id="261-åˆ›å»ºä¸€ä¸ªdispatch-source">2.6.1 åˆ›å»ºä¸€ä¸ªDispatch Source</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// API
dispatch_source_t source = dispatch_source_create(dispatch_source_type_t type, uintptr_t handle, unsigned long mask, dispatch_queue_t queue)

// æŒ‡å®šDISPATCH_SOURCE_TYPE_DATA_ADDï¼ŒåšæˆDispatch Source(åˆ†æ´¾æº)ã€‚è®¾å®šMain Dispatch Queue ä¸ºè¿½åŠ å¤„ç†çš„Dispatch Queue
_source = dispatch_source_create(DISPATCH_SOURCE_TYPE_DATA_ADD, 0, 0, dispatch_get_main_queue());
</code></pre></div></div>

<p><strong>å‚æ•°ï¼š</strong></p>

<table>
  <thead>
    <tr>
      <th>å‚æ•°</th>
      <th>æ„ä¹‰</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>type</td>
      <td>dispatchæºå¯å¤„ç†çš„äº‹ä»¶</td>
    </tr>
    <tr>
      <td>handle</td>
      <td>å¯ä»¥ç†è§£ä¸ºå¥æŸ„ã€ç´¢å¼•æˆ–idï¼Œå‡å¦‚è¦ç›‘å¬è¿›ç¨‹ï¼Œéœ€è¦ä¼ å…¥è¿›ç¨‹çš„ID</td>
    </tr>
    <tr>
      <td>mask</td>
      <td>å¯ä»¥ç†è§£ä¸ºæè¿°ï¼Œæä¾›æ›´è¯¦ç»†çš„æè¿°ï¼Œè®©å®ƒçŸ¥é“å…·ä½“è¦ç›‘å¬ä»€ä¹ˆ</td>
    </tr>
    <tr>
      <td>queue</td>
      <td>è‡ªå®šä¹‰æºéœ€è¦çš„ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”¨æ¥å¤„ç†æ‰€æœ‰çš„å“åº”å¥æŸ„ï¼ˆblockï¼‰</td>
    </tr>
  </tbody>
</table>

<p><code class="highlighter-rouge">Dispatch Source</code> å¯å¤„ç†çš„æ‰€æœ‰äº‹ä»¶ã€‚å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>

<table>
  <thead>
    <tr>
      <th>åç§°</th>
      <th>å†…å®¹</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">DISPATCH_SOURCE_TYPE_DATA_ADD</code></td>
      <td>å˜é‡å¢åŠ </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">DISPATCH_SOURCE_TYPE_DATA_OR</code></td>
      <td>å˜é‡OR</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">DISPATCH_SOURCE_TYPE_MACH_SEND</code></td>
      <td>MACHç«¯å£å‘é€</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">DISPATCH_SOURCE_TYPE_MACH_RECV</code></td>
      <td>MACHç«¯å£æ¥æ”¶</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">DISPATCH_SOURCE_TYPE_PROC</code></td>
      <td>ç›‘æµ‹åˆ°ä¸è¿›ç¨‹ç›¸å…³çš„äº‹ä»¶</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">DISPATCH_SOURCE_TYPE_READ</code></td>
      <td>å¯è¯»å–æ–‡ä»¶æ˜ åƒ</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">DISPATCH_SOURCE_TYPE_SIGNAL</code></td>
      <td>æ¥æ”¶ä¿¡å·</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">DISPATCH_SOURCE_TYPE_TIMER</code></td>
      <td>å®šæ—¶å™¨</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">DISPATCH_SOURCE_TYPE_VNODE</code></td>
      <td>æ–‡ä»¶ç³»ç»Ÿæœ‰å˜æ›´</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">DISPATCH_SOURCE_TYPE_WRITE</code></td>
      <td>å¯å†™å…¥æ–‡ä»¶æ˜ åƒ</td>
    </tr>
  </tbody>
</table>

<p>è‡ªå®šä¹‰æºä¹Ÿéœ€è¦ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”¨æ¥å¤„ç†æ‰€æœ‰çš„å“åº”å¥æŸ„ï¼ˆblockï¼‰ã€‚é‚£ä¹ˆå²‚ä¸æ˜¯æœ‰ä¸¤ä¸ªé˜Ÿåˆ—äº†ï¼Ÿæ²¡é”™ï¼Œè‡³äº <code class="highlighter-rouge">Dispatch Queue</code> è¿™ä¸ªé˜Ÿåˆ—çš„çº¿ç¨‹æ‰§è¡Œä¸ <code class="highlighter-rouge">Dispatch Source</code>è¿™ä¸ªé˜Ÿåˆ—çš„çº¿ç¨‹æ‰§è¡Œçš„å…³ç³»ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»ã€‚</p>

<h4 id="262-åˆ›å»ºdispatch-sourceçš„äº‹ä»¶å¤„ç†">2.6.2 åˆ›å»ºDispatch Sourceçš„äº‹ä»¶å¤„ç†</h4>

<p>åˆ›å»ºæºåï¼Œéœ€è¦æä¾›ç›¸åº”çš„å¤„ç†æ–¹æ³•ã€‚å½“æºç”Ÿæ•ˆæ—¶ä¼šåˆ†æ´¾æ³¨å†Œå¤„ç†æ–¹æ³•;å½“äº‹ä»¶å‘ç”Ÿæ—¶ä¼šåˆ†æ´¾äº‹ä»¶å¤„ç†æ–¹æ³•;å½“æºè¢«å–æ¶ˆæ—¶ä¼šåˆ†æ´¾å–æ¶ˆå¤„ç†æ–¹æ³•ã€‚è‡ªå®šä¹‰æºé€šå¸¸åªéœ€è¦ä¸€ä¸ªäº‹ä»¶å¤„ç†æ–¹æ³•ï¼Œå¯ä»¥åƒè¿™æ ·åˆ›å»º:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// æŒ‡å®šDISPATCH_SOURCE_TYPE_DATA_ADDï¼ŒåšæˆDispatch Source(åˆ†æ´¾æº)ã€‚è®¾å®šMain Dispatch Queue ä¸ºè¿½åŠ å¤„ç†çš„Dispatch Queue
_source = dispatch_source_create(DISPATCH_SOURCE_TYPE_DATA_ADD, 0, 0, dispatch_get_main_queue());

__block NSUInteger totalComplete = 0;
dispatch_source_set_event_handler(_source, ^{
    //å½“å¤„ç†äº‹ä»¶è¢«æœ€ç»ˆæ‰§è¡Œæ—¶ï¼Œè®¡ç®—åçš„æ•°æ®å¯ä»¥é€šè¿‡dispatch_source_get_dataæ¥è·å–ã€‚è¿™ä¸ªæ•°æ®çš„å€¼åœ¨æ¯æ¬¡å“åº”äº‹ä»¶æ‰§è¡Œåä¼šè¢«é‡ç½®ï¼Œæ‰€ä»¥totalCompleteçš„å€¼æ˜¯æœ€ç»ˆç´¯ç§¯çš„å€¼ã€‚
    NSUInteger value = dispatch_source_get_data(self-&gt;_source);
    totalComplete += value;
    NSLog(@"è¿›åº¦ï¼š%@", @((CGFloat)totalComplete/100));
    NSLog(@"ğŸ”µçº¿ç¨‹å·ï¼š%@", [NSThread currentThread]);
});

// åˆ†æ´¾æºåˆ›å»ºæ—¶é»˜è®¤å¤„äºæš‚åœçŠ¶æ€ï¼Œåœ¨åˆ†æ´¾æºåˆ†æ´¾å¤„ç†ç¨‹åºä¹‹å‰å¿…é¡»å…ˆæ¢å¤ã€‚
dispatch_resume(_source);

// æ¢å¤æºåï¼Œå°±å¯ä»¥é€šè¿‡dispatch_source_merge_dataå‘Dispatch Source(åˆ†æ´¾æº)å‘é€äº‹ä»¶:
dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
dispatch_async(queue, ^{
    for (NSUInteger index = 0; index &lt; 100; index++) {
        dispatch_source_merge_data(self-&gt;_source, 1);
        NSLog(@"â™»ï¸çº¿ç¨‹å·ï¼š%@", [NSThread currentThread]);
        usleep(20000);//0.02ç§’
    }
});
</code></pre></div></div>

<p>åœ¨åŒä¸€æ—¶é—´ï¼Œåªæœ‰ä¸€ä¸ªå¤„ç†æ–¹æ³•å—çš„å®ä¾‹è¢«åˆ†æ´¾ã€‚å¦‚æœè¿™ä¸ªå¤„ç†æ–¹æ³•è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œå¦ä¸€ä¸ªäº‹ä»¶å°±å‘ç”Ÿäº†ï¼Œäº‹ä»¶ä¼šä»¥æŒ‡å®šæ–¹å¼(ADDæˆ–è€…OR)è¿›è¡Œç´¯ç§¯ã€‚é€šè¿‡åˆå¹¶äº‹ä»¶çš„æ–¹å¼ï¼Œç³»ç»Ÿå³ä½¿åœ¨é«˜è´Ÿ è½½æƒ…å†µä¸‹ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œã€‚å½“å¤„ç†äº‹ä»¶ä»¶è¢«æœ€ç»ˆæ‰§è¡Œæ—¶ï¼Œè®¡ç®—åçš„æ•°æ®å¯ä»¥é€šè¿‡ <code class="highlighter-rouge">dispatch_source_get_data</code> æ¥è·å–ã€‚è¿™ä¸ªæ•°æ®çš„å€¼åœ¨æ¯æ¬¡å“åº”äº‹ä»¶æ‰§è¡Œåä¼šè¢«é‡ç½®ï¼Œæ‰€ä»¥ä¸Šé¢ä¾‹å­ä¸­ <code class="highlighter-rouge">totalComplete</code> çš„å€¼æ˜¯æœ€ç»ˆç´¯ç§¯çš„å€¼ã€‚</p>

<p>æ¢å¤æºåï¼Œå°±å¯ä»¥åƒä¸‹é¢çš„ä»£ç ç‰‡æ®µè¿™æ ·ï¼Œé€šè¿‡ <code class="highlighter-rouge">dispatch_source_merge_data</code> å‘åˆ†æ´¾æºå‘é€äº‹ä»¶ã€‚åœ¨æ¯æ¬¡å¾ªç¯ä¸­æ‰§è¡ŒåŠ 1æ“ä½œã€‚ä¹Ÿå¯ä»¥ä¼ é€’å·²å¤„ç†è®°å½•çš„æ•°ç›®æˆ–å·²å†™å…¥çš„å­—èŠ‚æ•°ã€‚åœ¨ä»»ä½•çº¿ç¨‹ä¸­éƒ½å¯ä»¥è°ƒç”¨ <code class="highlighter-rouge">dispatch_source_merge_data</code> ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸å¯ä»¥ä¼ é€’0å€¼(äº‹ä»¶ä¸ä¼šè¢«è§¦å‘)ï¼ŒåŒæ ·ä¹Ÿä¸å¯ä»¥ä¼ é€’è´Ÿæ•°ã€‚</p>

<h4 id="263-å¤„ç†dispatch-sourceçš„æš‚åœä¸æ¢å¤æ“ä½œ">2.6.3 å¤„ç†Dispatch Sourceçš„æš‚åœä¸æ¢å¤æ“ä½œ</h4>

<p>å½“è¿½åŠ å¤§é‡å¤„ç†åˆ°<code class="highlighter-rouge">Dispatch Queue</code>æ—¶ï¼Œåœ¨è¿½åŠ å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å¸Œæœ›ä¸æ‰§è¡Œå·²è¿½åŠ çš„å¤„ç†ã€‚ä¾‹å¦‚æ¼”ç®—ç»“æœè¢«Blockæˆªè·æ—¶ï¼Œä¸€äº›å¤„ç†ä¼šå¯¹è¿™ä¸ªæ¼”ç®—ç»“æœé€ æˆå½±å“ã€‚</p>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªè¦æŒ‚èµ·<code class="highlighter-rouge">Dispatch Queue</code>å³å¯ã€‚å½“å¯ä»¥æ‰§è¡Œæ—¶å†æ¢å¤ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_suspend(queue);
</code></pre></div></div>

<p><code class="highlighter-rouge">dispatch_resume</code> å‡½æ•°æ¢å¤æŒ‡å®šçš„ <code class="highlighter-rouge">Dispatch Queue</code> . è¿™äº›å‡½æ•°å¯¹å·²ç»æ‰§è¡Œçš„å¤„ç†æ²¡æœ‰å½±å“ã€‚æŒ‚èµ·åï¼Œè¿½åŠ åˆ° <code class="highlighter-rouge">Dispatch Queue</code> ä¸­ä½†å°šæœªæ‰§è¡Œçš„å¤„ç†åœ¨æ­¤ä¹‹ååœæ­¢æ‰§è¡Œã€‚è€Œæ¢å¤åˆ™ä½¿å¾—è¿™äº›å¤„ç†èƒ½å¤Ÿç»§ç»­æ‰§è¡Œã€‚</p>

<p>åˆ†æ´¾æºåˆ›å»ºæ—¶é»˜è®¤å¤„äºæš‚åœçŠ¶æ€ï¼Œåœ¨åˆ†æ´¾æºåˆ†æ´¾å¤„ç†ç¨‹åºä¹‹å‰å¿…é¡»å…ˆæ¢å¤ã€‚å› ä¸ºå¿˜è®°æ¢å¤åˆ†æ´¾æºçš„çŠ¶æ€è€Œäº§ç”Ÿbugæ˜¯å¸¸è§çš„äº‹å„¿ã€‚æ¢å¤çš„æ–¹æ³•æ˜¯è°ƒç”¨ <code class="highlighter-rouge">dispatch_resume</code> :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_resume (source);
</code></pre></div></div>

<p>æ€è€ƒä¸‹NSLogçš„æ‰“å°é¡ºåºä¸ºä»€ä¹ˆä¼šæ˜¯è¿™æ ·ï¼Ÿ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   dispatch_queue_t queue1 = dispatch_queue_create("com.serial.queue1", DISPATCH_QUEUE_SERIAL);
   dispatch_queue_t queue2 = dispatch_queue_create("com.serial.queue2", DISPATCH_QUEUE_SERIAL);
   dispatch_group_t group = dispatch_group_create();
   
   dispatch_async(queue1, ^{
       NSLog(@"ä»»åŠ¡ 1 ï¼š queue 1...");
       sleep(1);
       NSLog(@"âœ…å®Œæˆä»»åŠ¡ 1");
   });
   
   dispatch_async(queue2, ^{
       NSLog(@"ä»»åŠ¡ 1 ï¼š queue 2...");
       sleep(1);
       NSLog(@"âœ…å®Œæˆä»»åŠ¡ 2");
   });
   
   dispatch_group_async(group, queue1, ^{
       NSLog(@"ğŸš«æ­£åœ¨æš‚åœ 1");
       dispatch_suspend(queue1);
   });
   dispatch_group_async(group, queue2, ^{
       NSLog(@"ğŸš«æ­£åœ¨æš‚åœ 2");
       dispatch_suspend(queue2);
   });
   
   dispatch_group_wait(group, DISPATCH_TIME_FOREVER);
   NSLog(@"ï¼ï¼ï¼ï¼ï¼ï¼ï¼ç­‰å¾…ä¸¤ä¸ªqueueå®Œæˆ, å†å¾€ä¸‹è¿›è¡Œ...");
   dispatch_async(queue1, ^{
       NSLog(@"ä»»åŠ¡ 2 ï¼š queue 1");
   });
   dispatch_async(queue2, ^{
       NSLog(@"ä»»åŠ¡ 2 ï¼š queue 2");
   });
   NSLog(@"ğŸ”´ä¸ºä»€ä¹ˆè¿™ä¸ªNSLogä¼šåœ¨ä¸Šé¢ä¸¤ä¸ªNSLogä¹‹å‰æ‰“å°â“â“ç­”ï¼šdispatch_suspendçš„ä½œç”¨â€¼ï¸");
   
   dispatch_resume(queue1);
   dispatch_resume(queue2);
</code></pre></div></div>

:ET