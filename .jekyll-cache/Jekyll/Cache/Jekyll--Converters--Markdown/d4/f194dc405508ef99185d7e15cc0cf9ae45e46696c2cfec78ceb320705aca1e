I"„<p>layout: post
title: â€œiOS Runtimeåˆ†æâ€
author: â€œæèŒâ€
categories: learning
tags: [learning]
feature-img: â€œassets/img/article/runtime.jpgâ€
thumbnail: â€œassets/img/article/runtime.jpgâ€
typora-root-url: ../assets</p>

<p>Runtimeçš„ç‰¹æ€§ä¸»è¦æ˜¯æ¶ˆæ¯(<code class="highlighter-rouge">æ–¹æ³•</code>)ä¼ é€’ï¼Œå¦‚æœæ¶ˆæ¯(<code class="highlighter-rouge">æ–¹æ³•</code>)åœ¨å¯¹è±¡ä¸­æ‰¾ä¸åˆ°ï¼Œå°±è¿›è¡Œè½¬å‘ï¼Œå…·ä½“æ€ä¹ˆå®ç°çš„å‘¢ã€‚æˆ‘ä»¬ä»ä¸‹é¢å‡ ä¸ªæ–¹é¢æ¢å¯»Runtimeçš„å®ç°æœºåˆ¶ã€‚</p>

<h3 id="runtimeä»‹ç»">Runtimeä»‹ç»</h3>

<blockquote>
  <p>Objective-C æ‰©å±•äº† C è¯­è¨€ï¼Œå¹¶åŠ å…¥äº†é¢å‘å¯¹è±¡ç‰¹æ€§å’Œ Smalltalk å¼çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ã€‚è€Œè¿™ä¸ªæ‰©å±•çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªç”¨ C å’Œ ç¼–è¯‘è¯­è¨€ å†™çš„ Runtime åº“ã€‚å®ƒæ˜¯ Objective-C é¢å‘å¯¹è±¡å’ŒåŠ¨æ€æœºåˆ¶çš„åŸºçŸ³ã€‚</p>
</blockquote>

<blockquote>
  <p>Objective-C æ˜¯ä¸€ä¸ªåŠ¨æ€è¯­è¨€ï¼Œè¿™æ„å‘³ç€å®ƒä¸ä»…éœ€è¦ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œä¹Ÿéœ€è¦ä¸€ä¸ªè¿è¡Œæ—¶ç³»ç»Ÿæ¥åŠ¨æ€å¾—åˆ›å»ºç±»å’Œå¯¹è±¡ã€è¿›è¡Œæ¶ˆæ¯ä¼ é€’å’Œè½¬å‘ã€‚ç†è§£ Objective-C çš„ Runtime æœºåˆ¶å¯ä»¥å¸®æˆ‘ä»¬æ›´å¥½çš„äº†è§£è¿™ä¸ªè¯­è¨€ï¼Œé€‚å½“çš„æ—¶å€™è¿˜èƒ½å¯¹è¯­è¨€è¿›è¡Œæ‰©å±•ï¼Œä»ç³»ç»Ÿå±‚é¢è§£å†³é¡¹ç›®ä¸­çš„ä¸€äº›è®¾è®¡æˆ–æŠ€æœ¯é—®é¢˜ã€‚äº†è§£ Runtime ï¼Œè¦å…ˆäº†è§£å®ƒçš„æ ¸å¿ƒ - æ¶ˆæ¯ä¼ é€’ ï¼ˆMessagingï¼‰ã€‚</p>
</blockquote>

<p><code class="highlighter-rouge">Runtime</code> åŸºæœ¬æ˜¯ç”¨ <code class="highlighter-rouge">C</code> å’Œ<code class="highlighter-rouge">æ±‡ç¼–</code>å†™çš„ï¼Œå¯è§è‹¹æœä¸ºäº†åŠ¨æ€ç³»ç»Ÿçš„é«˜æ•ˆè€Œä½œå‡ºçš„åŠªåŠ›ã€‚ä½ å¯ä»¥åœ¨<a href="http://www.opensource.apple.com/source/objc4/">è¿™é‡Œ</a>ä¸‹åˆ°è‹¹æœç»´æŠ¤çš„å¼€æºä»£ç ã€‚è‹¹æœå’ŒGNUå„è‡ªç»´æŠ¤ä¸€ä¸ªå¼€æºçš„ <a href="https://github.com/RetVal/objc-runtime">runtime</a> ç‰ˆæœ¬ï¼Œè¿™ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´éƒ½åœ¨åŠªåŠ›çš„ä¿æŒä¸€è‡´ã€‚</p>

<p>å¹³æ—¶çš„ä¸šåŠ¡ä¸­ä¸»è¦æ˜¯ä½¿ç”¨<a href="https://developer.apple.com/reference/objectivec/objective_c_runtime#//apple_ref/doc/uid/TP40001418-CH1g-126286">å®˜æ–¹Api</a>ï¼Œè§£å†³æˆ‘ä»¬æ¡†æ¶æ€§çš„éœ€æ±‚ã€‚</p>

<p>é«˜çº§ç¼–ç¨‹è¯­è¨€æƒ³è¦æˆä¸ºå¯æ‰§è¡Œæ–‡ä»¶éœ€è¦å…ˆç¼–è¯‘ä¸ºæ±‡ç¼–è¯­è¨€å†æ±‡ç¼–ä¸ºæœºå™¨è¯­è¨€ï¼Œæœºå™¨è¯­è¨€ä¹Ÿæ˜¯è®¡ç®—æœºèƒ½å¤Ÿè¯†åˆ«çš„å”¯ä¸€è¯­è¨€ï¼Œä½†æ˜¯<code class="highlighter-rouge">OC</code>å¹¶ä¸èƒ½ç›´æ¥ç¼–è¯‘ä¸ºæ±‡ç¼–è¯­è¨€ï¼Œè€Œæ˜¯è¦å…ˆè½¬å†™ä¸ºçº¯<code class="highlighter-rouge">C</code>è¯­è¨€å†è¿›è¡Œç¼–è¯‘å’Œæ±‡ç¼–çš„æ“ä½œï¼Œä»<code class="highlighter-rouge">OC</code>åˆ°<code class="highlighter-rouge">C</code>è¯­è¨€çš„è¿‡æ¸¡å°±æ˜¯ç”±runtimeæ¥å®ç°çš„ã€‚ç„¶è€Œæˆ‘ä»¬ä½¿ç”¨<code class="highlighter-rouge">OC</code>è¿›è¡Œé¢å‘å¯¹è±¡å¼€å‘ï¼Œè€Œ<code class="highlighter-rouge">C</code>è¯­è¨€æ›´å¤šçš„æ˜¯é¢å‘è¿‡ç¨‹å¼€å‘ï¼Œè¿™å°±éœ€è¦å°†é¢å‘å¯¹è±¡çš„ç±»è½¬å˜ä¸ºé¢å‘è¿‡ç¨‹çš„ç»“æ„ä½“ã€‚</p>

<h3 id="runtimeæ¶ˆæ¯ä¼ é€’">Runtimeæ¶ˆæ¯ä¼ é€’</h3>

<p>ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•åƒè¿™æ ·<code class="highlighter-rouge">[obj message]</code>ï¼Œç¼–è¯‘å™¨è½¬æˆæ¶ˆæ¯å‘é€<code class="highlighter-rouge">objc_msgSend(obj, message)</code>ï¼Œ<code class="highlighter-rouge">Runtime</code>æ—¶æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>

<ul>
  <li>é¦–å…ˆï¼Œé€šè¿‡<code class="highlighter-rouge">obj</code>çš„<code class="highlighter-rouge">isa</code>æŒ‡é’ˆæ‰¾åˆ°å®ƒçš„<code class="highlighter-rouge">classs</code>ï¼›</li>
  <li>åœ¨<code class="highlighter-rouge">class</code>çš„<code class="highlighter-rouge">method list</code>æ‰¾<code class="highlighter-rouge">messge</code>ï¼›</li>
  <li>å¦‚æœ<code class="highlighter-rouge">class</code>ä¸­æ²¡æœ‰æ‰¾åˆ°<code class="highlighter-rouge">messge</code>ï¼Œç»§ç»­å¾€å®ƒçš„<code class="highlighter-rouge">superclass</code>ä¸­æ‰¾ï¼›</li>
  <li>ä¸€æ—¦æ‰¾åˆ°<code class="highlighter-rouge">message</code>è¿™ä¸ªå‡½æ•°ï¼Œå°±å»æ‰§è¡Œå®ƒçš„å®ç°<code class="highlighter-rouge">IMP</code>ã€‚</li>
</ul>

<p>ä½†è¿™ç§å®ç°å­˜åœ¨é—®é¢˜ï¼Œæ•ˆç‡ä½ã€‚å› ä¸ºä¸€ä¸ª<code class="highlighter-rouge">class</code>é€šå¸¸åªæœ‰<code class="highlighter-rouge">20%</code>çš„å‡½æ•°ä¼šç»å¸¸è¢«è°ƒç”¨ï¼Œå¯èƒ½å æ€»è°ƒç”¨æ¬¡æ•°çš„<code class="highlighter-rouge">80%</code>ã€‚æ¯ä¸ªæ¶ˆæ¯éƒ½éœ€è¦éå†ä¸€æ¬¡<code class="highlighter-rouge">objc_method_list</code>å¹¶ä¸åˆç†ã€‚è€Œ<code class="highlighter-rouge">objc_class</code>ä¸­å¦å¤–ä¸€ä¸ªé‡è¦æˆå‘˜<code class="highlighter-rouge">objc_cache</code>å°±ä¼šæ¶ˆé™¤ä¸Šè¿°é—®é¢˜ï¼Œåœ¨æ‰¾åˆ°<code class="highlighter-rouge">message</code>ä¹‹åï¼Œä¼šæŠŠ<code class="highlighter-rouge">message</code>çš„<code class="highlighter-rouge">method_name</code>ä½œä¸º<code class="highlighter-rouge">key</code>ï¼Œ<code class="highlighter-rouge">method_imp</code>ä½œä¸º<code class="highlighter-rouge">value</code>å­˜å‚¨èµ·æ¥ã€‚å½“å†æ¬¡å—åˆ°<code class="highlighter-rouge">message</code>æ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨<code class="highlighter-rouge">objc_cache</code>é‡Œæ‰¾åˆ°ï¼Œé¿å…å»éå†<code class="highlighter-rouge">objc_method_list</code>ã€‚</p>

<p><code class="highlighter-rouge">objc_msgSend</code>çš„æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OBJC_EXPORT void objc_msgSend(void /* id self, SEL op, ... */ )
</code></pre></div></div>

<p>é‚£ä¹ˆæ¶ˆæ¯ä¼ é€’æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæˆ‘ä»¬çœ‹çœ‹å¯¹è±¡(<code class="highlighter-rouge">object</code>)ï¼Œç±»(<code class="highlighter-rouge">class</code>)ï¼Œæ–¹æ³•(<code class="highlighter-rouge">method</code>)è¿™å‡ ä¸ªç»“æ„ä½“ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// å¯¹è±¡
struct objc_object {
    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;
};

// ç±»
struct objc_class {
    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;
#if !__OBJC2__
    Class _Nullable super_class                              OBJC2_UNAVAILABLE;
    const char * _Nonnull name                               OBJC2_UNAVAILABLE;
    long version                                             OBJC2_UNAVAILABLE;
    long info                                                OBJC2_UNAVAILABLE;
    long instance_size                                       OBJC2_UNAVAILABLE;
    struct objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;
    struct objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;
    struct objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;
    struct objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;
#endif
} OBJC2_UNAVAILABLE;

// æ–¹æ³•åˆ—è¡¨
struct objc_method_list {
    struct objc_method_list * _Nullable obsolete             OBJC2_UNAVAILABLE;
    int method_count                                         OBJC2_UNAVAILABLE;
#ifdef __LP64__
    int space                                                OBJC2_UNAVAILABLE;
#endif
    /* variable length structure */
    struct objc_method method_list[1]                        OBJC2_UNAVAILABLE;
}                                                            OBJC2_UNAVAILABLE

// æ–¹æ³•
struct objc_method {
    SEL _Nonnull method_name                                 OBJC2_UNAVAILABLE;
    char * _Nullable method_types                            OBJC2_UNAVAILABLE;
    IMP _Nonnull method_imp                                  OBJC2_UNAVAILABLE;
}                                                            OBJC2_UNAVAILABLE;
</code></pre></div></div>

<ol>
  <li>
    <p>ç³»ç»Ÿé¦–å…ˆæ‰¾åˆ°æ¶ˆæ¯çš„æ¥æ”¶å¯¹è±¡ï¼Œç„¶åé€šè¿‡å¯¹è±¡<code class="highlighter-rouge">isa</code>æŒ‡é’ˆæ‰¾åˆ°å®ƒçš„ç±»<code class="highlighter-rouge">class</code>ã€‚</p>
  </li>
  <li>
    <p>åœ¨å®ƒçš„ç±»ä¸­æŸ¥æ‰¾<code class="highlighter-rouge">method_list</code>ï¼Œæ˜¯å¦æœ‰<code class="highlighter-rouge">selector</code>æ–¹æ³•ã€‚</p>
  </li>
  <li>
    <p>æ²¡æœ‰åˆ™æŸ¥æ‰¾çˆ¶ç±»çš„<code class="highlighter-rouge">method_list</code>ã€‚</p>
  </li>
  <li>
    <p>æ‰¾åˆ°å¯¹åº”çš„<code class="highlighter-rouge">method</code>ï¼Œæ‰§è¡Œå®ƒçš„<code class="highlighter-rouge">IMP</code>ã€‚</p>
  </li>
  <li>
    <p>è½¬å‘<code class="highlighter-rouge">IMP</code>çš„<code class="highlighter-rouge">return</code>å€¼ã€‚</p>
  </li>
</ol>

<h4 id="ç±»å¯¹è±¡objc_class">ç±»å¯¹è±¡(objc_class)</h4>

<p><code class="highlighter-rouge">Objective-C</code>ç±»æ˜¯ç”±<code class="highlighter-rouge">Class</code>ç±»å‹æ¥è¡¨ç¤ºçš„ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘<code class="highlighter-rouge">objc_class</code>ç»“æ„ä½“çš„æŒ‡é’ˆã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct objc_class *Class;
</code></pre></div></div>

<p>æŸ¥çœ‹<code class="highlighter-rouge">objc/runtime.h</code>ä¸­<code class="highlighter-rouge">objc_class</code>ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct objc_class {
    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;
    
#if !__OBJC2__
    Class _Nullable super_class                              OBJC2_UNAVAILABLE;
    const char * _Nonnull name                               OBJC2_UNAVAILABLE;
    long version                                             OBJC2_UNAVAILABLE;
    long info                                                OBJC2_UNAVAILABLE;
    long instance_size                                       OBJC2_UNAVAILABLE;
    struct objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;
    struct objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;
    struct objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;
    struct objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;
#endif

} OBJC2_UNAVAILABLE;
</code></pre></div></div>

<p><code class="highlighter-rouge">struct objc_class</code>ç»“æ„ä½“é‡Œä¿å­˜äº†æŒ‡å‘çˆ¶ç±»çš„æŒ‡é’ˆã€ç±»çš„åç§°ã€ç‰ˆæœ¬ã€å®ä¾‹å¤§å°ã€å®ä¾‹å˜é‡åˆ—è¡¨ï¼Œæ–¹æ³•åˆ—è¡¨ã€ç¼“å­˜ã€éµå¾ªåè®®åˆ—è¡¨ç­‰ã€‚
ç±»å¯¹è±¡å°±æ˜¯ä¸€ä¸ªç»“æ„ä½“<code class="highlighter-rouge">struct objc_class</code>ï¼Œè¿™ä¸ªç»“æ„ä½“å­˜æ”¾çš„æ•°æ®æˆä¸ºå…ƒæ•°æ®(<code class="highlighter-rouge">metadata</code>)ã€‚
è¯¥ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡<code class="highlighter-rouge">isa</code>æŒ‡é’ˆï¼Œè¿™å°±è¯´æ˜ç±»æœ¬èº«å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬ç§°<code class="highlighter-rouge">objc_class</code>å…¶ä¸ºç±»å¯¹è±¡ï¼Œç±»å¯¹è±¡åœ¨ç¼–è¯‘æœŸäº§ç”Ÿç”¨äºåˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œç±»å¯¹è±¡æ˜¯å•ä¾‹ã€‚</p>

<h4 id="å®ä¾‹å¯¹è±¡objc_object">å®ä¾‹å¯¹è±¡(objc_object)</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct objc_object {
    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;
};

typedef struct objc_object *id;
</code></pre></div></div>

<p>å®ä¾‹å¯¹è±¡ä¸­<code class="highlighter-rouge">isa</code>æŒ‡é’ˆæŒ‡å‘ç±»å¯¹è±¡<code class="highlighter-rouge">objc_class</code>ã€‚
ç±»å¯¹è±¡ä¸­çš„å…ƒæ•°æ®å­˜å‚¨çš„éƒ½æ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ªå®ä¾‹çš„ç›¸å…³ä¿¡æ¯ï¼Œé‚£ä¹ˆç±»å¯¹è±¡å’Œç±»æ–¹æ³•åº”è¯¥ä»å“ªé‡Œåˆ›å»ºå‘¢ï¼Ÿ
å°±æ˜¯ä»<code class="highlighter-rouge">isa</code>æŒ‡é’ˆæŒ‡å‘çš„ç»“æ„ä½“åˆ›å»ºï¼Œç±»å¯¹è±¡çš„<code class="highlighter-rouge">isa</code>æŒ‡é’ˆ</p>

<h4 id="å…ƒç±»meta-class">å…ƒç±»(Meta Class)</h4>

<p><img src="https://raw.githubusercontent.com/limeng99/limeng99.github.io/master/assets/img/screenshots/runtime-meta.png" alt="runtime-meta" /></p>

<p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ•´ä¸ªä½“ç³»æ„æˆäº†ä¸€ä¸ªè‡ªé—­ç¯ï¼Œ<code class="highlighter-rouge">struct objc_object</code>ç»“æ„ä½“<code class="highlighter-rouge">å®ä¾‹</code>å®ƒçš„<code class="highlighter-rouge">isa</code>æŒ‡é’ˆæŒ‡å‘ç±»å¯¹è±¡ï¼›
ç±»å¯¹è±¡çš„<code class="highlighter-rouge">isa</code>æŒ‡é’ˆæŒ‡å‘äº†å…ƒç±»ï¼Œ<code class="highlighter-rouge">super_class</code>æŒ‡é’ˆæŒ‡å‘çˆ¶ç±»çš„ç±»å¯¹è±¡ï¼›
è€Œå…ƒç±»çš„<code class="highlighter-rouge">super_class</code>æŒ‡é’ˆæŒ‡å‘äº†çˆ¶ç±»çš„å…ƒç±»ï¼Œé‚£å…ƒç±»çš„<code class="highlighter-rouge">isa</code>æŒ‡é’ˆåˆæŒ‡å‘äº†<code class="highlighter-rouge">NSObjectå…ƒç±»</code>ï¼›
<code class="highlighter-rouge">NSObject</code>çš„å…ƒç±»<code class="highlighter-rouge">meta-class</code>çš„<code class="highlighter-rouge">super_class</code>æŒ‡é’ˆæŒ‡å‘äº†<code class="highlighter-rouge">NSObjectç±»å¯¹è±¡</code>ï¼Œ<code class="highlighter-rouge">isa</code>æŒ‡é’ˆæŒ‡å‘äº†è‡ªå·±ã€‚</p>

<p>å…ƒç±»(Meta Class)æ˜¯ä¸€ä¸ªç±»å¯¹è±¡çš„ç±»ã€‚
æ‰€æœ‰çš„ç±»è‡ªèº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å‘è¿™ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯(å³è°ƒç”¨ç±»æ–¹æ³•)ã€‚
ä¸ºäº†è°ƒç”¨ç±»æ–¹æ³•ï¼Œè¿™ä¸ªç±»çš„<code class="highlighter-rouge">isa</code>æŒ‡é’ˆå¿…é¡»æŒ‡å‘ä¸€ä¸ªåŒ…å«è¿™äº›ç±»æ–¹æ³•çš„ä¸€ä¸ª<code class="highlighter-rouge">objc_class</code>ç»“æ„ä½“ã€‚è¿™å°±å¼•å‡ºäº†<code class="highlighter-rouge">meta-class</code>çš„æ¦‚å¿µï¼Œå…ƒç±»ä¸­ä¿å­˜äº†åˆ›å»ºç±»å¯¹è±¡åŠç±»æ–¹æ³•æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚
ä»»ä½•<code class="highlighter-rouge">NSObject</code>ç»§æ‰¿ä½“ç³»ä¸‹çš„<code class="highlighter-rouge">meta-class</code>éƒ½ä½¿ç”¨<code class="highlighter-rouge">NSObject</code>çš„<code class="highlighter-rouge">meta-class</code>ä½œä¸ºè‡ªå·±çš„æ‰€å±ç±»ï¼Œè€ŒåŸºç±»çš„<code class="highlighter-rouge">meta-class</code>çš„<code class="highlighter-rouge">isa</code>æŒ‡é’ˆæŒ‡å‘å®ƒè‡ªå·±ã€‚</p>

<h4 id="methodobjc_method">Method(Objc_method)</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct objc_method *Method;

struct objc_method {
    SEL _Nonnull method_name                                 OBJC2_UNAVAILABLE;
    char * _Nullable method_types                            OBJC2_UNAVAILABLE;
    IMP _Nonnull method_imp                                  OBJC2_UNAVAILABLE;
}                                                            
</code></pre></div></div>

<p><code class="highlighter-rouge">Method</code>å’Œå¹³æ—¶ç†è§£çš„å‡½æ•°æ˜¯ä¸€è‡´çš„ï¼Œå°±æ˜¯è¡¨ç¤ºèƒ½å¤Ÿç‹¬ç«‹å®Œæˆä¸€ä¸ªåŠŸèƒ½çš„ä¸€æ®µä»£ç ã€‚
<code class="highlighter-rouge">objc_method</code>ç»“æ„ä½“å†…å®¹ï¼š</p>
<ul>
  <li><code class="highlighter-rouge">SEL _Nonnull method_name</code> æ–¹æ³•å</li>
  <li><code class="highlighter-rouge">char * _Nullable method_types</code> æ–¹æ³•ç±»å‹</li>
  <li><code class="highlighter-rouge">IMP _Nonnull method_imp</code> æ–¹æ³•å®ç°</li>
</ul>

<p>ä»æ­¤çœ‹å‡ºï¼Œ<code class="highlighter-rouge">SEL</code>å’Œ<code class="highlighter-rouge">IMP</code>å‡æ˜¯<code class="highlighter-rouge">Method</code>çš„å±æ€§ã€‚</p>

<h4 id="selobjc_selector">SEL(objc_selector)</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct objc_selector *SEL;
</code></pre></div></div>

<p><code class="highlighter-rouge">objc_msgSend</code>å‡½æ•°ç¬¬äºŒä¸ªå‚æ•°ç±»å‹æ˜¯<code class="highlighter-rouge">SEL</code>ï¼Œå®ƒæ˜¯<code class="highlighter-rouge">selector</code>åœ¨<code class="highlighter-rouge">Objective-C</code>ä¸­çš„è¡¨ç¤ºç±»å‹ï¼ˆ<code class="highlighter-rouge">Swift</code>ä¸­æ˜¯<code class="highlighter-rouge">Selector</code>ç±»ï¼‰ã€‚<code class="highlighter-rouge">selector</code>æ˜¯æ–¹æ³•é€‰æ‹©å™¨ï¼Œå¯ä»¥ç†è§£åŒºåˆ†æ–¹æ³•çš„<code class="highlighter-rouge">ID</code>ï¼Œè€Œè¿™ä¸ª<code class="highlighter-rouge">ID</code>çš„æ•°æ®ç»“æ„æ˜¯<code class="highlighter-rouge">SEL</code>ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@property SEL selector;
</code></pre></div></div>

<p>å¯ä»¥çœ‹å‡ºæ¥<code class="highlighter-rouge">selector</code>æ˜¯<code class="highlighter-rouge">SEL</code>çš„ä¸€ä¸ªå®ä¾‹ã€‚
å…¶å®<code class="highlighter-rouge">selector</code>å°±æ˜¯ä¸ªæ˜ å°„åˆ°æ–¹æ³•çš„<code class="highlighter-rouge">C</code>å­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥ç”¨<code class="highlighter-rouge">Objective-C</code>ç¼–è¯‘å™¨å‘½ä»¤<code class="highlighter-rouge">@selector()</code>æˆ–è€…<code class="highlighter-rouge">Runtime</code>ç³»ç»Ÿçš„<code class="highlighter-rouge">sel_registerName</code>å‡½æ•°æ¥è·å–ä¸€ä¸ª<code class="highlighter-rouge">SEL</code>ç±»å‹çš„æ–¹æ³•é€‰æ‹©å™¨ã€‚</p>

<p><code class="highlighter-rouge">selector</code>æ—¢ç„¶æ˜¯ä¸€ä¸ª<code class="highlighter-rouge">string</code>ï¼Œåº”è¯¥æ˜¯ç±»ä¼¼<code class="highlighter-rouge">className+method</code>çš„ç»„åˆï¼Œå‘½åè§„åˆ™æœ‰ä¸¤æ¡ï¼š</p>

<ul>
  <li>åŒä¸€ä¸ªç±»ï¼Œ<code class="highlighter-rouge">selector</code>ä¸èƒ½é‡å¤</li>
  <li>ä¸åŒçš„ç±»ï¼Œ<code class="highlighter-rouge">selector</code>å¯ä»¥é‡å¤</li>
</ul>

<p>è¿™æ ·ä¼šæœ‰ä¸€ä¸ªå¼Šç«¯ï¼Œæˆ‘ä»¬åœ¨å†™<code class="highlighter-rouge">C</code>ä»£ç çš„æ—¶å€™ï¼Œç»å¸¸ä¼šç”¨åˆ°å‡½æ•°é‡è½½ï¼Œå°±æ˜¯å‡½æ•°åç›¸åŒï¼Œå‚æ•°ä¸åŒï¼Œä½†æ˜¯è¿™åœ¨<code class="highlighter-rouge">Objective-C</code>ä¸­æ˜¯è¡Œä¸é€šçš„ï¼Œå› ä¸º<code class="highlighter-rouge">selector</code>åªè®°äº†<code class="highlighter-rouge">className+method</code>ï¼Œæ²¡æœ‰å‚æ•°ï¼Œæ‰€ä»¥æ²¡æ³•å–è´¹ä¸åŒçš„<code class="highlighter-rouge">method</code>ã€‚</p>

<p>æ¯”å¦‚ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- (void)caculate(NSInteger)num;
- (void)caculate(CGFloat)num;
</code></pre></div></div>

<p>è¿™æ ·æ˜¯ä¼šæŠ¥é”™çš„ã€‚</p>

<p>æˆ‘ä»¬åªèƒ½é€šè¿‡å‘½åæ¥åŒºåˆ†ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- (void)caculateWithInt(NSInteger)num;
- (void)caculateWithFloat(CGFloat)num;
</code></pre></div></div>

<p>åœ¨ä¸åŒç±»ä¸­ç›¸åŒåå­—çš„æ–¹æ³•æ‰€å¯¹åº”çš„é€‰æ‹©å™¨æ˜¯ç›¸åŒçš„ï¼Œå³ä½¿æ–¹æ³•åå­—ç›¸åŒè€Œå˜é‡ç±»å‹ä¸åŒä¹Ÿä¼šå¯¼è‡´ä»–ä»¬å…·æœ‰ç›¸åŒçš„æ–¹æ³•é€‰æ‹©å™¨ã€‚</p>

<h4 id="imp">IMP</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef id _Nullable (*IMP)(id _Nonnull, SEL _Nonnull, ...); 
</code></pre></div></div>

<p>å°±æ˜¯æŒ‡å‘æœ€ç»ˆå®ç°ç¨‹åºçš„å†…å­˜åœ°å€çš„æŒ‡é’ˆã€‚</p>

<p>åœ¨<code class="highlighter-rouge">iOS</code>çš„<code class="highlighter-rouge">Runtime</code>ä¸­ï¼Œ<code class="highlighter-rouge">Method</code>é€šè¿‡<code class="highlighter-rouge">selector</code>å’Œ<code class="highlighter-rouge">IMP</code>ä¸¤ä¸ªå±æ€§ï¼Œå®ç°äº†å¿«é€ŸæŸ¥è¯¢æ–¹æ³•åŠå®ç°ï¼Œç›¸å¯¹æé«˜äº†æ€§èƒ½ï¼Œåˆä¿æŒäº†çµæ´»æ€§ã€‚</p>

<h4 id="ç±»ç¼“å­˜objc_cache">ç±»ç¼“å­˜(objc_cache)</h4>

<p>å½“<code class="highlighter-rouge">Objective-C</code>è¿è¡Œæ—¶é€šè¿‡è·Ÿè¸ªå®ƒçš„<code class="highlighter-rouge">isa</code>æŒ‡é’ˆæ£€æŸ¥å¯¹è±¡æ—¶ï¼Œå®ƒå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå®ç°è®¸å¤šæ–¹æ³•çš„å¯¹è±¡ã€‚ç„¶è€Œï¼Œä½ å¯èƒ½åªè°ƒç”¨å®ƒä»¬çš„ä¸€å°éƒ¨åˆ†ï¼Œå¹¶ä¸”æ¯æ¬¡æŸ¥æ‰¾æ—¶ï¼Œæœç´¢æ‰€æœ‰é€‰æ‹©å™¨çš„ç±»åˆ†æ´¾è¡¨æ²¡æœ‰æ„ä¹‰ã€‚æ‰€ä»¥ç±»å®ç°ä¸€ä¸ªç¼“å­˜ï¼Œæ¯å½“ä½ æœç´¢ä¸€ä¸ªç±»åˆ†æ´¾è¡¨ï¼Œå¹¶æ‰¾åˆ°ç›¸åº”çš„é€‰æ‹©å™¨ï¼Œå®ƒæŠŠå®ƒæ”¾å…¥å®ƒçš„ç¼“å­˜ã€‚æ‰€ä»¥å½“<code class="highlighter-rouge">objc_msgSend</code>æŸ¥æ‰¾ä¸€ä¸ªç±»çš„é€‰æ‹©å™¨ï¼Œå®ƒé¦–å…ˆæœç´¢ç±»ç¼“å­˜ã€‚è¿™æ˜¯åŸºäºè¿™æ ·çš„ç†è®ºï¼šå¦‚æœä½ åœ¨ç±»ä¸Šè°ƒç”¨ä¸€ä¸ªæ¶ˆæ¯ï¼Œä½ å¯èƒ½ä»¥åå†æ¬¡è°ƒç”¨è¯¥æ¶ˆæ¯ã€‚</p>

<p>ä¸ºäº†åŠ é€Ÿæ¶ˆæ¯åˆ†å‘ï¼Œ ç³»ç»Ÿä¼šå¯¹æ–¹æ³•å’Œå¯¹åº”çš„åœ°å€è¿›è¡Œç¼“å­˜ï¼Œå°±æ”¾åœ¨ä¸Šè¿°çš„<code class="highlighter-rouge">objc_cache</code>ï¼Œæ‰€ä»¥åœ¨å®é™…è¿è¡Œä¸­ï¼Œå¤§éƒ¨åˆ†å¸¸ç”¨çš„æ–¹æ³•éƒ½æ˜¯ä¼šè¢«ç¼“å­˜èµ·æ¥çš„ï¼Œ<code class="highlighter-rouge">Runtime</code>ç³»ç»Ÿå®é™…ä¸Šéå¸¸å¿«ï¼Œæ¥è¿‘ç›´æ¥æ‰§è¡Œå†…å­˜åœ°å€çš„ç¨‹åºé€Ÿåº¦ã€‚</p>

<h4 id="categoryobjc_category">Category(objc_category)</h4>

<p><code class="highlighter-rouge">Category</code>æ˜¯è¡¨ç¤ºä¸€ä¸ªæŒ‡å‘åˆ†ç±»çš„ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct category_t { 
    const char *name; 
    classref_t cls; 
    struct method_list_t *instanceMethods; 
    struct method_list_t *classMethods;
    struct protocol_list_t *protocols;
    struct property_list_t *instanceProperties;
};

nameï¼šæ˜¯æŒ‡ class_name è€Œä¸æ˜¯ category_nameã€‚
clsï¼šè¦æ‰©å±•çš„ç±»å¯¹è±¡ï¼Œç¼–è¯‘æœŸé—´æ˜¯ä¸ä¼šå®šä¹‰çš„ï¼Œè€Œæ˜¯åœ¨Runtimeé˜¶æ®µé€šè¿‡nameå¯¹ åº”åˆ°å¯¹åº”çš„ç±»å¯¹è±¡ã€‚
instanceMethodsï¼šcategoryä¸­æ‰€æœ‰ç»™ç±»æ·»åŠ çš„å®ä¾‹æ–¹æ³•çš„åˆ—è¡¨ã€‚
classMethodsï¼šcategoryä¸­æ‰€æœ‰æ·»åŠ çš„ç±»æ–¹æ³•çš„åˆ—è¡¨ã€‚
protocolsï¼šcategoryå®ç°çš„æ‰€æœ‰åè®®çš„åˆ—è¡¨ã€‚
instancePropertiesï¼šè¡¨ç¤ºCategoryé‡Œæ‰€æœ‰çš„propertiesï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡objc_setAssociatedObjectå’Œobjc_getAssociatedObjectå¢åŠ å®ä¾‹å˜é‡çš„åŸå› ï¼Œä¸è¿‡è¿™ä¸ªå’Œä¸€èˆ¬çš„å®ä¾‹å˜é‡æ˜¯ä¸ä¸€æ ·çš„ã€‚
</code></pre></div></div>

<p>ä»ä¸Šé¢çš„<code class="highlighter-rouge">objc_category</code>çš„ç»“æ„ä½“ä¸­å¯ä»¥çœ‹å‡ºï¼Œåˆ†ç±»ä¸­å¯ä»¥æ·»åŠ å®ä¾‹æ–¹æ³•ï¼Œç±»æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥å®ç°åè®®ï¼Œæ·»åŠ å±æ€§ï¼Œä¸å¯ä»¥æ·»åŠ æˆå‘˜å˜é‡ã€‚</p>

<h3 id="runtimeæ¶ˆæ¯è½¬å‘">Runtimeæ¶ˆæ¯è½¬å‘</h3>

<p>ä¸Šæ–‡ä¸­ä»‹ç»äº†è¿›è¡Œä¸€æ¬¡æ¶ˆæ¯å‘é€ä¼šåœ¨ç›¸å…³ç±»å¯¹è±¡ä¸­æœç´¢æ–¹æ³•åˆ—è¡¨ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™ä¼šæ²¿ç€ç»§æ‰¿æ ‘å‘ä¸Šä¸€ç›´æœç´¢ç›´åˆ°ç»§æ‰¿æ ‘çš„æ ¹éƒ¨(é€šå¸¸ä¸º<code class="highlighter-rouge">NSObject</code>)ï¼Œå¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿæ¥ä¸‹æ¥ä¼šé€ä¸€ä»‹ç»æ¶ˆæ¯è½¬å‘çš„æµç¨‹ï¼Œå…ˆçœ‹ä¸‹å›¾ï¼š</p>

<p><img src="https://raw.githubusercontent.com/limeng99/limeng99.github.io/master/assets/img/screenshots/runtime-forward.png" alt="runtime-forward" /></p>

<p>æ¶ˆæ¯è½¬å‘ä¸‰ä¸ªæ­¥éª¤ï¼šåŠ¨æ€æ–¹æ³•è§£æï¼›å¤‡ç”¨æ¥æ”¶è€…ï¼›å®Œæ•´æ¶ˆæ¯è½¬å‘ã€‚</p>

<h4 id="åŠ¨æ€æ–¹æ³•è§£æ">åŠ¨æ€æ–¹æ³•è§£æ</h4>

<p>é¦–å…ˆï¼Œ<code class="highlighter-rouge">Objective-C</code>è¿è¡Œæ—¶ä¼šè°ƒç”¨<code class="highlighter-rouge">+resolveInstanceMethod:</code>æˆ–è€…<code class="highlighter-rouge">+resolveClassMethod:</code>ï¼Œè®©ä½ æœ‰æœºä¼šæä¾›ä¸€ä¸ªå‡½æ•°å®ç°ã€‚å¦‚æœä½ æ·»åŠ äº†å‡½æ•°å¹¶è¿”å›<code class="highlighter-rouge">Yes</code>ï¼Œé‚£è¿è¡Œæ—¶ç³»ç»Ÿå°±ä¼šé‡æ–°å¯åŠ¨ä¸€æ¬¡æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- (void)viewDidLoad {
    [super viewDidLoad];

    // æ‰§è¡Œmsgå‡½æ•°
    [self performSelector:@selector(msg:)];
}

+ (BOOL)resolveInstanceMethod:(SEL)sel {
    // æ£€æµ‹åˆ°å¦‚æœæ˜¯æ‰§è¡Œmsgå‡½æ•°ï¼Œå°±åŠ¨æ€è§£æï¼ŒæŒ‡å®šæ–°çš„IMP
    if (sel == @selector(msg:)) {
        class_addMethod([self class], sel, (IMP)msgMethod, "v@:");
        return YES;
    }
    return [super resolveInstanceMethod:sel];
}

// æ–°çš„msgå‡½æ•°
void msgMethod(id obj, SEL _cmd) {
    NSLog(@"Receive message");
}
</code></pre></div></div>

<p>æ‰“å°æ—¥å¿—ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2020-01-02 10:01:00.294697+0800 Runtime-Demo[44489:1441571] Receive message
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°è™½ç„¶æ²¡æœ‰å®ç°<code class="highlighter-rouge">msg:</code>å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬é€šè¿‡<code class="highlighter-rouge">class_addMethod</code>åŠ¨æ€æ·»åŠ <code class="highlighter-rouge">msgMethod</code>å‡½æ•°ï¼Œå¹¶æ‰§è¡Œ<code class="highlighter-rouge">msgMethod</code>è¿™ä¸ªå‡½æ•°çš„<code class="highlighter-rouge">IMP</code>ã€‚ä»æ‰“å°æ—¥å¿—çœ‹ï¼ŒæˆåŠŸå®ç°äº†æ¶ˆæ¯è½¬å‘ã€‚</p>

<p>å¦‚æœ<code class="highlighter-rouge">+resolveInstanceMethod:</code>æ–¹æ³•<code class="highlighter-rouge">NO</code>ï¼Œè¿è¡Œæ—¶å°±ä¼šç§»åˆ°ä¸‹ä¸€æ­¥<code class="highlighter-rouge">-forwardingTargetForSelector:</code>ã€‚</p>

<h4 id="å¤‡ç”¨æ¥æ”¶è€…">å¤‡ç”¨æ¥æ”¶è€…</h4>

<p>å¦‚æœç›®æ ‡å¯¹è±¡å®ç°äº†<code class="highlighter-rouge">-forwardingTargetForSelector:</code>ï¼Œ<code class="highlighter-rouge">Runtime</code>è¿™æ—¶å°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œç»™ä½ æŠŠè¿™ä¸ªæ¶ˆæ¯è½¬å‘ç»™å…¶ä»–å¯¹è±¡çš„æœºä¼šã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import "ViewController.h"
#import &lt;objc/runtime.h&gt;

@interface Receiver: NSObject

@end

@implementation Receiver

// Receiverçš„msgå‡½æ•°
- (void)msg {
    NSLog(@"Receive message");
}

@end

@interface ViewController ()

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];

    // æ‰§è¡Œmsgå‡½æ•°
    [self performSelector:@selector(msg)];
}

+ (BOOL)resolveInstanceMethod:(SEL)sel {
    return NO; //è¿”å›NOï¼Œè¿›å…¥ä¸‹ä¸€æ­¥è½¬å‘
}

- (id)forwardingTargetForSelector:(SEL)aSelector {
    if (aSelector == @selector(msg)) {
        return [Receiver new]; //è¿”å›Receiverå¯¹è±¡ï¼Œè®©Receiverå¯¹è±¡æ¥æ”¶è¿™ä¸ªæ¶ˆæ¯
    }
    return [super forwardingTargetForSelector:aSelector];
}

@end
</code></pre></div></div>

<p>æ‰“å°æ—¥å¿—ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2020-01-02 10:16:20.360133+0800 Runtime-Demo[44635:1453911] Receive message
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡<code class="highlighter-rouge">-forwardingTargetForSelector:</code>æŠŠå½“å‰<code class="highlighter-rouge">ViewController</code>çš„æ–¹æ³•è½¬å‘ç»™äº†<code class="highlighter-rouge">Receiver</code>å»æ‰§è¡Œäº†ã€‚æ‰“å°ç»“æœä¹Ÿè¯æ˜æˆ‘ä»¬æˆåŠŸå®ç°äº†è½¬å‘ã€‚</p>

<h4 id="å®Œæ•´æ¶ˆæ¯è½¬å‘">å®Œæ•´æ¶ˆæ¯è½¬å‘</h4>

<p>å¦‚æœä»¥ä¸Šä¸¤æ­¥è¿˜ä¸èƒ½å¤„ç†æœªçŸ¥æ¶ˆæ¯ï¼Œåˆ™å”¯ä¸€èƒ½åšçš„å°±æ˜¯å¯åŠ¨å®Œæ•´çš„æ¶ˆæ¯è½¬å‘æœºåˆ¶äº†ã€‚é¦–å…ˆå®ƒä¼šå‘é€<code class="highlighter-rouge">methodSignatureForSelector:</code>æ¶ˆæ¯è·å¾—å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ã€‚å¦‚æœ<code class="highlighter-rouge">methodSignatureForSelector:</code>è¿”å›<code class="highlighter-rouge">nil</code>ï¼Œè¿è¡Œæ—¶ç³»ç»Ÿåˆ™ä¼šå‘å‡º<code class="highlighter-rouge">doesNotRecognizeSelector:</code>æ¶ˆæ¯ï¼Œç¨‹åºä¹Ÿå°±æŒ‚æ‰äº†ã€‚å¦‚æœè¿”å›äº†ä¸€ä¸ªå‡½æ•°ç­¾åï¼Œè¿è¡Œæ—¶å°±ä¼šåˆ›å»ºä¸€ä¸ª<code class="highlighter-rouge">NSInvocation</code>å¯¹è±¡å¹¶å‘é€<code class="highlighter-rouge">-forwardInvocation:</code>æ¶ˆæ¯ç»™ç›®æ ‡å¯¹è±¡ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import "ViewController.h"
#import &lt;objc/runtime.h&gt;

@interface Receiver: NSObject

@end

@implementation Receiver

// Receiverçš„msgå‡½æ•°
- (void)msg {
    NSLog(@"Receive message");
}

@end

@interface ViewController ()

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];

    // æ‰§è¡Œmsgå‡½æ•°
    [self performSelector:@selector(msg)];
}

+ (BOOL)resolveInstanceMethod:(SEL)sel {
    return NO; //è¿”å›NOï¼Œè¿›å…¥ä¸‹ä¸€æ­¥è½¬å‘
}

- (id)forwardingTargetForSelector:(SEL)aSelector {
    return nil;//è¿”å›nilï¼Œè¿›å…¥ä¸‹ä¸€æ­¥è½¬å‘
}

- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector {
    if ([NSStringFromSelector(aSelector) isEqualToString:@"msg"]) {
    		//ç­¾åï¼Œè¿›å…¥forwardInvocation
        return [NSMethodSignature signatureWithObjCTypes:"v@:"];
    }
    
    return [super methodSignatureForSelector:aSelector];
}

- (void)forwardInvocation:(NSInvocation *)anInvocation {
    SEL sel = anInvocation.selector;
    
    Receiver *receiver = [Receiver new];
    if([receiver respondsToSelector:sel]) {
        [anInvocation invokeWithTarget:receiver];
    }
    else {
        [self doesNotRecognizeSelector:sel];
    }
}

@end
</code></pre></div></div>

<p>æ‰“å°æ—¥å¿—ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2020-01-02 11:06:11.223700+0800 Runtime-Demo[46932:1491762] Receive message
</code></pre></div></div>

<p>ä»æ‰“å°æ—¥å¿—çœ‹ï¼Œæˆ‘ä»¬å®ç°äº†å®Œæ•´çš„æ¶ˆæ¯è½¬å‘ã€‚é€šè¿‡ç­¾åï¼Œ<code class="highlighter-rouge">Runtime</code>ç”Ÿæˆäº†ä¸€ä¸ªå¯¹è±¡<code class="highlighter-rouge">anInvocation</code>ï¼Œå‘é€ç»™äº†<code class="highlighter-rouge">forwardInvocation</code>ï¼Œæˆ‘ä»¬åœ¨<code class="highlighter-rouge">forwardInvocation</code>æ–¹æ³•é‡Œé¢è®©<code class="highlighter-rouge">Receiver</code>å¯¹è±¡å»æ‰§è¡Œäº†<code class="highlighter-rouge">msg</code>å‡½æ•°ã€‚ç­¾åå‚æ•°<code class="highlighter-rouge">v@:</code>æ€ä¹ˆè§£é‡Šå‘¢ï¼Œè¿™é‡Œè‹¹æœæ–‡æ¡£<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100-SW1">Type Encodings</a>æœ‰è¯¦ç»†çš„è§£é‡Šã€‚</p>

<h3 id="runtimeåº”ç”¨">Runtimeåº”ç”¨</h3>

<p><code class="highlighter-rouge">Runtime</code>ç®€ç›´å°±æ˜¯åšå¤§å‹æ¡†æ¶çš„åˆ©å™¨ã€‚å®ƒçš„åº”ç”¨åœºæ™¯éå¸¸å¤šã€‚</p>

<h4 id="å…³è”å¯¹è±¡objective-c-associated-objectsç»™åˆ†ç±»å¢åŠ å±æ€§">å…³è”å¯¹è±¡(Objective-C Associated Objects)ç»™åˆ†ç±»å¢åŠ å±æ€§</h4>

<p>åˆ†ç±»æ˜¯ä¸èƒ½å®šä¹‰å±æ€§å’Œå˜é‡çš„ï¼Œä¸‹é¢é€šè¿‡å…³è”å¯¹è±¡å®ç°ç»™åˆ†ç±»æ·»åŠ å±æ€§ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//å…³è”å¯¹è±¡
void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy)
//è·å–å…³è”çš„å¯¹è±¡
id objc_getAssociatedObject(id object, const void *key)
//ç§»é™¤å…³è”çš„å¯¹è±¡
void objc_removeAssociatedObjects(id object)

id objectï¼šè¢«å…³è”çš„å¯¹è±¡
const void *keyï¼šå…³è”çš„keyï¼Œè¦æ±‚å”¯ä¸€
id valueï¼šå…³è”çš„å¯¹è±¡
objc_AssociationPolicy policyï¼šå†…å­˜ç®¡ç†çš„ç­–ç•¥


// å†…å­˜ç®¡ç†çš„ç­–ç•¥
typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) {
    OBJC_ASSOCIATION_ASSIGN = 0,           /**&lt; Specifies a weak reference to the associated object. */
    OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, /**&lt; Specifies a strong reference to the associated object. 
                                            *   The association is not made atomically. */
    OBJC_ASSOCIATION_COPY_NONATOMIC = 3,   /**&lt; Specifies that the associated object is copied. 
                                            *   The association is not made atomically. */
    OBJC_ASSOCIATION_RETAIN = 01401,       /**&lt; Specifies a strong reference to the associated object.
                                            *   The association is made atomically. */
    OBJC_ASSOCIATION_COPY = 01403          /**&lt; Specifies that the associated object is copied.
                                            *   The association is made atomically. */
};
</code></pre></div></div>

<p>å†…å­˜ç­–ç•¥çš„å±æ€§ä¿®é¥°</p>

<table>
  <thead>
    <tr>
      <th>å†…å­˜ç­–ç•¥</th>
      <th>å±æ€§ä¿®é¥°</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>OBJC_ASSOCIATION_ASSIGN</td>
      <td>@property (assign) æˆ– @property (unsafe_unretained)</td>
      <td>æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼±å¼•ç”¨ã€‚</td>
    </tr>
    <tr>
      <td>OBJC_ASSOCIATION_RETAIN_NONATOMIC</td>
      <td>@property (nonatomic, strong)</td>
      <td>@property (nonatomic, strong)   æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œä¸èƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚</td>
    </tr>
    <tr>
      <td>OBJC_ASSOCIATION_COPY_NONATOMIC</td>
      <td>@property (nonatomic, copy)</td>
      <td>æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„copyå¼•ç”¨ï¼Œä¸èƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚</td>
    </tr>
    <tr>
      <td>OBJC_ASSOCIATION_RETAIN</td>
      <td>@property (atomic, strong)</td>
      <td>æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œèƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚</td>
    </tr>
    <tr>
      <td>OBJC_ASSOCIATION_COPY</td>
      <td>@property (atomic, copy)</td>
      <td>æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„copyå¼•ç”¨ï¼Œèƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚</td>
    </tr>
  </tbody>
</table>

<p>å®ç°<code class="highlighter-rouge">UIImage</code>åˆ†ç±»æ·»åŠ è‡ªå®šä¹‰å±æ€§<code class="highlighter-rouge">name</code>ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// UIImage+Runtime.h
@interface UIImage (Runtime)

@property (nonatomic, copy) NSString *name;

@end

// UIImage+Runtime.m
#import "UIImage+Runtime.h"
#import &lt;objc/runtime.h&gt;

@implementation UIImage (Runtime)

- (void)setName:(NSString *)name {
    objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}

- (NSString *)name {
    return objc_getAssociatedObject(self, _cmd);
}

@end

// ViewController.m
- (void)viewDidLoad {
    [super viewDidLoad];

    UIImage *image = [UIImage new];
    image.name = @"image_pic";
    NSLog(@"name: %@", image.name);
}
</code></pre></div></div>

<p>æ‰“å°æ—¥å¿—ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2020-01-02 11:27:39.232196+0800 Runtime-Demo[47163:1508917] name: image_pic
</code></pre></div></div>

<p>æ‰“å°ç»“æœæ¥çœ‹ï¼Œæˆ‘ä»¬æˆåŠŸåœ¨åˆ†ç±»ä¸Šæ·»åŠ äº†ä¸€ä¸ªå±æ€§ï¼Œå®ç°äº†å®ƒçš„<code class="highlighter-rouge">setter</code>å’Œ<code class="highlighter-rouge">getter</code>æ–¹æ³•ã€‚
 é€šè¿‡å…³è”å¯¹è±¡å®ç°çš„å±æ€§çš„å†…å­˜ç®¡ç†ä¹Ÿæ˜¯æœ‰<code class="highlighter-rouge">ARC</code>ç®¡ç†çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç»™å®šé€‚å½“çš„å†…å­˜ç­–ç•¥å°±è¡Œäº†ï¼Œä¸éœ€è¦æ“å¿ƒå¯¹è±¡çš„é‡Šæ”¾ã€‚</p>

<h4 id="æ–¹æ³•é­”æ³•method-swizzling">æ–¹æ³•é­”æ³•(Method Swizzling)</h4>

<p>å¯¹ä¸Šé¢çš„<code class="highlighter-rouge">UIImage</code>çš„åˆ†ç±»è¿›è¡Œè¿›ä¸€æ­¥æ‰©å±•ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// UIImage+Runtime.h
@interface UIImage (Runtime)

@property (nonatomic, copy) NSString *name;

@end

// UIImage+Runtime.m
#import "UIImage+Runtime.h"
#import &lt;objc/runtime.h&gt;

@implementation UIImage (Runtime)

+ (void)load {
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        Class class = [self class];
        
        Method originalMethod = class_getClassMethod(class, @selector(imageNamed:));
        Method swizzledMethod = class_getClassMethod(class, @selector(rep_imageNamed:));
        
        BOOL add = class_addMethod(class, @selector(imageNamed:), method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));
        if (add) {
            class_replaceMethod(class, @selector(rep_imageNamed:), method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));
        } else {
            method_exchangeImplementations(originalMethod, swizzledMethod);
        }
    });
}

+ (UIImage *)rep_imageNamed:(NSString *)imageName {
    UIImage *image = [self rep_imageNamed:imageName];
    image.name = imageName;
    return image;
}

- (void)setName:(NSString *)name {
    objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}

- (NSString *)name {
    return objc_getAssociatedObject(self, _cmd);
}

@end

// ViewController.m

</code></pre></div></div>

<p>æ‰“å°æ—¥å¿—ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2020-01-02 11:45:01.073499+0800 Runtime-Demo[47296:1522764] name: image_pic
</code></pre></div></div>

:ET