I"¡o<p>æœ¬äººä¹Ÿçœ‹ç€ä¼—å¤§ç¥çš„æ–‡ç« æ‰å¯¹runloopæœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œå¸Œæœ›é€šè¿‡è¿™ç¯‡æ–‡ç« æ¥è®°å½•å¹¶åŠ æ·±å¯¹runloopçš„ç†è§£ã€‚<a href="https://opensource.apple.com/tarballs/CF/">CFRunloopæºä»£ç </a></p>

<h3 id="ä¸€runloopç®€ä»‹">ä¸€ã€RunLoopç®€ä»‹</h3>

<p>RunLoop å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç®¡ç†äº†å…¶éœ€è¦å¤„ç†çš„äº‹ä»¶å’Œæ¶ˆæ¯ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªå…¥å£å‡½æ•°æ¥æ‰§è¡Œä¸Šé¢ Event Loop çš„é€»è¾‘ã€‚çº¿ç¨‹æ‰§è¡Œäº†è¿™ä¸ªå‡½æ•°åï¼Œå°±ä¼šä¸€ç›´å¤„äºè¿™ä¸ªå‡½æ•°å†…éƒ¨ â€œæ¥å—æ¶ˆæ¯-&gt;ç­‰å¾…-&gt;å¤„ç†â€ çš„å¾ªç¯ä¸­ï¼Œç›´åˆ°è¿™ä¸ªå¾ªç¯ç»“æŸï¼ˆæ¯”å¦‚ä¼ å…¥ quit çš„æ¶ˆæ¯ï¼‰ï¼Œå‡½æ•°è¿”å›ã€‚</p>

<p>OSX/iOS ç³»ç»Ÿä¸­ï¼Œæä¾›äº†ä¸¤ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼š<code class="highlighter-rouge">NSRunLoop</code> å’Œ <code class="highlighter-rouge">CFRunLoopRef</code>ã€‚</p>

<ul>
  <li><code class="highlighter-rouge">CFRunLoopRef</code> æ˜¯åœ¨ <code class="highlighter-rouge">CoreFoundation</code> æ¡†æ¶å†…çš„ï¼Œå®ƒæä¾›äº†çº¯ C å‡½æ•°çš„ APIï¼Œæ‰€æœ‰è¿™äº› API éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
  <li><code class="highlighter-rouge">NSRunLoop</code> æ˜¯åŸºäº <code class="highlighter-rouge">CFRunLoopRef</code> çš„å°è£…ï¼Œæä¾›äº†é¢å‘å¯¹è±¡çš„ APIï¼Œä½†æ˜¯è¿™äº› API ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ul>

<h3 id="äºŒrunloopä¸çº¿ç¨‹å…³ç³»">äºŒã€RunLoopä¸çº¿ç¨‹å…³ç³»</h3>

<p>RunLoop å’Œçº¿ç¨‹æ˜¯æ¯æ¯ç›¸å…³çš„ï¼Œæˆ‘ä»¬çŸ¥é“çº¿ç¨‹çš„ä½œç”¨æ˜¯ç”¨æ¥æ‰§è¡Œç‰¹å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ‰§è¡Œå®Œä¹‹åå°±ä¼šé€€å‡ºï¼Œå°±ä¸èƒ½å†æ‰§è¡Œä»»åŠ¡äº†ã€‚è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦é‡‡ç”¨ä¸€ç§æ–¹å¼æ¥è®©çº¿ç¨‹èƒ½å¤Ÿä¸æ–­åœ°å¤„ç†ä»»åŠ¡ï¼Œå¹¶ä¸é€€å‡ºã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±æœ‰äº† RunLoopã€‚</p>

<p>è‹¹æœä¸å…è®¸ç›´æ¥åˆ›å»º RunLoopï¼Œå®ƒåªæä¾›äº†ä¸¤ä¸ªè‡ªåŠ¨è·å–çš„å‡½æ•°ï¼š<code class="highlighter-rouge">CFRunLoopGetMain()</code> å’Œ <code class="highlighter-rouge">CFRunLoopGetCurrent()</code>ã€‚ è¿™ä¸¤ä¸ªå‡½æ•°æºç ä¸ºä¸‹é¢è¿™æ ·:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// å…¨å±€çš„Dictionaryï¼Œkey æ˜¯ pthread_tï¼Œ value æ˜¯ CFRunLoopRef
static CFMutableDictionaryRef __CFRunLoops = NULL;
// è®¿é—® __CFRunLoops æ—¶çš„é”
static CFSpinLock_t loopsLock = CFSpinLockInit;

CF_EXPORT CFRunLoopRef _CFRunLoopGet0(pthread_t t) {
    if (pthread_equal(t, kNilPthreadT)) {
				t = pthread_main_thread_np();
    }
    __CFSpinLock(&amp;loopsLock);
    if (!__CFRunLoops) {
    		// ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶ï¼Œåˆå§‹åŒ–å…¨å±€ __CFRunLoopsï¼Œå¹¶å…ˆä¸ºä¸»çº¿ç¨‹åˆ›å»ºä¸€ä¸ª RunLoop
        __CFSpinUnlock(&amp;loopsLock);
				CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, &amp;kCFTypeDictionaryValueCallBacks);
				CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np());
				CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop);
        if (!OSAtomicCompareAndSwapPtrBarrier(NULL, dict, (void * volatile *)&amp;__CFRunLoops)) {
            CFRelease(dict);
        }
				CFRelease(mainLoop);
        __CFSpinLock(&amp;loopsLock);
    }
    // ç›´æ¥ä» __CFRunLoops é‡Œè·å–
    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));
    __CFSpinUnlock(&amp;loopsLock);
    if (!loop) {
    		// è·å–ä¸åˆ°æ—¶ï¼Œåˆ›å»ºä¸€ä¸ª
				CFRunLoopRef newLoop = __CFRunLoopCreate(t);
        __CFSpinLock(&amp;loopsLock);
				loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));
				if (!loop) {
	    			CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);
	    			loop = newLoop;
				}
   			 __CFSpinUnlock(&amp;loopsLock);
				CFRelease(newLoop);
    }
    if (pthread_equal(t, pthread_self())) {
    		// æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“çº¿ç¨‹é”€æ¯æ—¶ï¼Œé¡ºä¾¿ä¹Ÿé”€æ¯å…¶å¯¹åº”çš„ RunLoopã€‚
       	_CFSetTSD(__CFTSDKeyRunLoop, (void *)loop, NULL);
        if (0 == _CFGetTSD(__CFTSDKeyRunLoopCntr)) {
            _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(PTHREAD_DESTRUCTOR_ITERATIONS-1), (void (* (void *))__CFFinalizeRunLoop);
        }
    }
    return loop;
}

CFRunLoopRef CFRunLoopGetMain(void) {
    CHECK_FOR_FORK();
    static CFRunLoopRef __main = NULL; // no retain needed
    // pthread_main_thread_np() ä¸ºä¸»çº¿ç¨‹
    if (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np()); // no CAS needed
    return __main;
}

CFRunLoopRef CFRunLoopGetCurrent(void) {
    CHECK_FOR_FORK();
    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);
    if (rl) return rl;
    // pthread_self() ä¸ºå½“å‰çº¿ç¨‹
    return _CFRunLoopGet0(pthread_self());
}

void CFRunLoopRun(void) {	/* DOES CALLOUT */
    int32_t result;
    do {
        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, 1.0e10, false);
        CHECK_FOR_FORK();
    } while (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);
}
</code></pre></div></div>

<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œçº¿ç¨‹å’Œ RunLoop ä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶å…³ç³»æ˜¯ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„ Dictionary é‡Œã€‚çº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰ RunLoopï¼Œå¦‚æœä½ ä¸ä¸»åŠ¨è·å–ï¼Œé‚£å®ƒä¸€ç›´éƒ½ä¸ä¼šæœ‰ã€‚RunLoop çš„åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶ï¼ŒRunLoop çš„é”€æ¯æ˜¯å‘ç”Ÿåœ¨çº¿ç¨‹ç»“æŸæ—¶ã€‚ä½ åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹çš„å†…éƒ¨è·å–å…¶ RunLoopï¼ˆä¸»çº¿ç¨‹é™¤å¤–ï¼‰ã€‚</p>

<p>RunLoopä¸çº¿ç¨‹ä¹‹é—´çš„å…³ç³»å¯†ä¸å¯åˆ†:</p>

<ul>
  <li>çº¿ç¨‹ä¸RunLoopæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªRunLoopå¯¹è±¡ï¼ŒRunLoopä¸èƒ½è‡ªå·±åˆ›å»ºã€‚</li>
  <li>ä¸»çº¿ç¨‹çš„RunLoopåœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œéä¸»çº¿ç¨‹çš„RunLoopéœ€è¦åœ¨è¯¥çº¿ç¨‹è‡ªå·±å¯åŠ¨ã€‚</li>
  <li>RunLoopå¯¹è±¡åœ¨ç¬¬ä¸€æ¬¡è·å–RunLoopæ—¶åˆ›å»ºï¼Œé”€æ¯åˆ™æ˜¯åœ¨çº¿ç¨‹ç»“æŸçš„æ—¶å€™ã€‚</li>
  <li>RunLoopå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåªèƒ½åœ¨å½“å‰çº¿ç¨‹ä¸­æ“ä½œå½“å‰çº¿ç¨‹çš„RunLoopï¼Œè€Œä¸èƒ½å»æ“ä½œå…¶ä»–çº¿ç¨‹çš„RunLoopï¼ŒåŒæ—¶ä¹Ÿéœ€è¦é¿å…åœ¨å…¶ä»–çº¿ç¨‹ä¸Šè°ƒç”¨å½“å‰çº¿ç¨‹çš„RunLoopã€‚</li>
</ul>

<h3 id="ä¸‰runloopç›¸å…³ç±»">ä¸‰ã€RunLoopç›¸å…³ç±»</h3>

<p>åœ¨ <code class="highlighter-rouge">CoreFoundation</code> é‡Œé¢å…³äº RunLoop æœ‰5ä¸ªç±»:</p>

<ol>
  <li><code class="highlighter-rouge">CFRunLoopRef</code>ï¼šä»£è¡¨ RunLoop çš„å¯¹è±¡</li>
  <li><code class="highlighter-rouge">CFRunLoopModeRef</code>ï¼šä»£è¡¨ RunLoop çš„è¿è¡Œæ¨¡å¼</li>
  <li><code class="highlighter-rouge">CFRunLoopSourceRef</code>ï¼šå°±æ˜¯ RunLoop æ¨¡å‹å›¾ä¸­æåˆ°çš„è¾“å…¥æº / äº‹ä»¶æº</li>
  <li><code class="highlighter-rouge">CFRunLoopTimerRef</code>ï¼šå°±æ˜¯ RunLoop æ¨¡å‹å›¾ä¸­æåˆ°çš„å®šæ—¶æº</li>
  <li><code class="highlighter-rouge">CFRunLoopObserverRef</code>ï¼šè§‚å¯Ÿè€…ï¼Œèƒ½å¤Ÿç›‘å¬ RunLoop çš„çŠ¶æ€æ”¹å˜</li>
</ol>

<p>å…¶ä¸­ <code class="highlighter-rouge">CFRunLoopModeRef</code> ç±»å¹¶æ²¡æœ‰å¯¹å¤–æš´éœ²ï¼Œåªæ˜¯é€šè¿‡ <code class="highlighter-rouge">CFRunLoopRef </code>çš„æ¥å£è¿›è¡Œäº†å°è£…ã€‚ä»–ä»¬çš„å…³ç³»å¦‚ä¸‹:</p>

<p><img src="https://raw.githubusercontent.com/limeng99/limeng99.github.io/master/assets/img/screenshots/runloop-class.png" alt="runloop-class" /></p>

<p>ä¸€ä¸ªRunLoopå¯¹è±¡<code class="highlighter-rouge">CFRunLoopRef</code>ä¸­åŒ…å«è‹¥å¹²ä¸ªè¿è¡Œæ¨¡å¼<code class="highlighter-rouge">CFRunLoopModeRef</code>ã€‚è€Œæ¯ä¸€ä¸ªè¿è¡Œæ¨¡å¼ä¸‹åˆåŒ…å«è‹¥å¹²ä¸ªè¾“å…¥æº<code class="highlighter-rouge">CFRunLoopSourceRef</code>ã€å®šæ—¶æº<code class="highlighter-rouge">CFRunLoopTimerRef</code>ã€è§‚å¯Ÿè€…<code class="highlighter-rouge">CFRunLoopObserverRef</code>ã€‚</p>

<ul>
  <li>
    <p>æ¯æ¬¡ RunLoop å¯åŠ¨æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ªè¿è¡Œæ¨¡å¼<code class="highlighter-rouge">CFRunLoopModeRef</code>ï¼Œè¿™ä¸ªè¿è¡Œæ¨¡å¼<code class="highlighter-rouge">CFRunLoopModeRef</code>è¢«ç§°ä½œå½“å‰è¿è¡Œæ¨¡å¼<code class="highlighter-rouge">CurrentMode</code>ã€‚</p>
  </li>
  <li>
    <p>å¦‚æœéœ€è¦åˆ‡æ¢è¿è¡Œæ¨¡å¼<code class="highlighter-rouge">CFRunLoopModeRef</code>ï¼Œåªèƒ½é€€å‡ºå½“å‰ RunLoopï¼Œå†é‡æ–°æŒ‡å®šä¸€ä¸ªè¿è¡Œæ¨¡å¼<code class="highlighter-rouge">CFRunLoopModeRef</code>è¿›å…¥ã€‚</p>
  </li>
  <li>
    <p>ä¸»è¦æ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„è¾“å…¥æº<code class="highlighter-rouge">CFRunLoopSourceRef</code>ã€å®šæ—¶æº<code class="highlighter-rouge">CFRunLoopTimerRef</code>ã€è§‚å¯Ÿè€…<code class="highlighter-rouge">CFRunLoopObserverRef</code>ï¼Œè®©å…¶äº’ä¸å½±å“ã€‚</p>
  </li>
</ul>

<h4 id="31-cfrunloopref">3.1 CFRunLoopRef</h4>

<p><code class="highlighter-rouge">CFRunLoopRef</code> æ˜¯ <code class="highlighter-rouge">Core Foundation</code> æ¡†æ¶ä¸‹ RunLoop å¯¹è±¡ç±»ã€‚æˆ‘ä»¬å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥è·å– RunLoop å¯¹è±¡ï¼š</p>

<p>Core Foundation æ¡†æ¶ä¸‹:</p>

<ul>
  <li><code class="highlighter-rouge">CFRunLoopGetCurrent();</code> // è·å¾—å½“å‰çº¿ç¨‹çš„ RunLoop å¯¹è±¡</li>
  <li><code class="highlighter-rouge">CFRunLoopGetMain(); </code> // è·å¾—ä¸»çº¿ç¨‹çš„ RunLoop å¯¹è±¡</li>
</ul>

<p>åœ¨Foundationæ¡†æ¶ä¸‹</p>

<ul>
  <li><code class="highlighter-rouge">[NSRunLoop currentRunLoop];</code> // è·å¾—å½“å‰çº¿ç¨‹çš„ RunLoop å¯¹è±¡</li>
  <li><code class="highlighter-rouge">[NSRunLoop mainRunLoop];</code> // è·å¾—ä¸»çº¿ç¨‹çš„ RunLoop å¯¹è±¡</li>
</ul>

<p><code class="highlighter-rouge">CFRunLoopRef</code>æºç ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct __CFRunLoop {
    ...
    CFMutableSetRef _commonModes; 			// Set é›†åˆ
    CFMutableSetRef _commonModeItems;   // Set&lt;Source/Observer/Timer&gt; é›†åˆ 
    CFRunLoopModeRef _currentMode;			// Current Runloop Mode
    CFMutableSetRef _modes;							// Set é›†åˆ
    ...
};
</code></pre></div></div>

<h4 id="32-cfrunloopmoderef">3.2 CFRunLoopModeRef</h4>

<p>ç³»ç»Ÿé»˜è®¤å®šä¹‰äº†å¤šç§è¿è¡Œæ¨¡å¼<code class="highlighter-rouge">CFRunLoopModeRef</code>ï¼Œå¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong><code class="highlighter-rouge">kCFRunLoopDefaultMode</code></strong>ï¼šAppçš„é»˜è®¤è¿è¡Œæ¨¡å¼ï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ªè¿è¡Œæ¨¡å¼ä¸‹è¿è¡Œ</li>
  <li><strong><code class="highlighter-rouge">UITrackingRunLoopMode</code></strong>ï¼šè·Ÿè¸ªç”¨æˆ·äº¤äº’äº‹ä»¶ï¼ˆç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–Modeå½±å“ï¼‰</li>
  <li><code class="highlighter-rouge">UIInitializationRunLoopMode</code>ï¼šåœ¨åˆšå¯åŠ¨Appæ—¶ç¬¬è¿›å…¥çš„ç¬¬ä¸€ä¸ª Modeï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨</li>
  <li><code class="highlighter-rouge">GSEventReceiveRunLoopMode</code>ï¼šæ¥å—ç³»ç»Ÿå†…éƒ¨äº‹ä»¶ï¼Œé€šå¸¸ç”¨ä¸åˆ°</li>
  <li><strong><code class="highlighter-rouge">kCFRunLoopCommonModes</code></strong>ï¼šä¼ªæ¨¡å¼ï¼Œä¸æ˜¯ä¸€ç§çœŸæ­£çš„è¿è¡Œæ¨¡å¼ï¼ˆåè¾¹ä¼šç”¨åˆ°ï¼‰</li>
</ol>

<p>å…¶ä¸­<strong><code class="highlighter-rouge">kCFRunLoopDefaultMode</code></strong>ã€<strong><code class="highlighter-rouge">UITrackingRunLoopMode</code></strong>ã€<strong><code class="highlighter-rouge">kCFRunLoopCommonModes</code></strong>æ˜¯æˆ‘ä»¬å¼€å‘ä¸­éœ€è¦ç”¨åˆ°çš„æ¨¡å¼ã€‚</p>

<p><code class="highlighter-rouge">CFRunLoopModeRef</code>æºç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct __CFRunLoopMode {
    ...
    CFStringRef _name;  							// Mode Name, ä¾‹å¦‚ @"kCFRunLoopDefaultMode"
    CFMutableSetRef _sources0;				// Set é›†åˆ
    CFMutableSetRef _sources1;				// Set é›†åˆ
    CFMutableArrayRef _observers;     // Array æ•°ç»„
    CFMutableArrayRef _timers;				// Array æ•°ç»„
    CFMutableDictionaryRef _portToV1SourceMap;
    __CFPortSet _portSet;
    CFIndex _observerMask;
		....
    uint64_t _timerSoftDeadline; /* TSR */
    uint64_t _timerHardDeadline; /* TSR */
};
</code></pre></div></div>

<p>ä¸€ä¸ª RunLoop å¯¹è±¡åŒ…å«è‹¥å¹²ä¸ª Mode å¯¹è±¡ï¼Œæ¯ä¸ª Mode åˆåŒ…å«è‹¥å¹²ä¸ª Source/Timer/Observerï¼ŒRunLoop ä¸€æ¬¡è¿è¡Œåªèƒ½åœ¨ä¸€ä¸ª Mode ä¹‹ä¸‹ï¼Œå¦‚æœéœ€è¦åˆ‡æ¢ Modeï¼Œéœ€è¦é€€å‡º RunLoop æ‰èƒ½é‡æ–°æŒ‡å®šä¸€ä¸ª Modeã€‚è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„Source/Timer/Observerï¼Œè®©å…¶äº’ä¸å½±å“ã€‚</p>

<h4 id="33-cfrunlooptimerref">3.3 CFRunLoopTimerRef</h4>

<p><code class="highlighter-rouge">CFRunLoopTimerRef</code>æ˜¯å®šæ—¶æºï¼ˆRunLoopæ¨¡å‹å›¾ä¸­æåˆ°è¿‡ï¼‰ï¼Œç†è§£ä¸ºåŸºäºæ—¶é—´çš„è§¦å‘å™¨ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯<code class="highlighter-rouge">NSTimer</code>ã€‚</p>

<p>ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„é—®é¢˜ï¼šæ»‘åŠ¨tableViewæ—¶ï¼Œå®šæ—¶å™¨è¿˜ä¼šç”Ÿæ•ˆå—ï¼Ÿ</p>

<p>é»˜è®¤æƒ…å†µä¸‹RunLoopè¿è¡Œåœ¨<code class="highlighter-rouge">kCFRunLoopDefaultMode</code>ä¸‹ï¼Œè€Œå½“æ»‘åŠ¨tableViewæ—¶ï¼ŒRunLoopåˆ‡æ¢åˆ°<code class="highlighter-rouge">UITrackingRunLoopMode</code>ï¼Œè€ŒTimeræ˜¯åœ¨<code class="highlighter-rouge">kCFRunLoopDefaultMode</code>ä¸‹çš„ï¼Œå°±æ— æ³•æ¥å—å¤„ç†Timerçš„äº‹ä»¶ã€‚</p>

<p>æ€ä¹ˆå»è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼ŸæŠŠTimeræ·»åŠ åˆ°UITrackingRunLoopModeä¸Šå¹¶ä¸èƒ½è§£å†³é—®é¢˜ï¼Œå› ä¸ºè¿™æ ·åœ¨é»˜è®¤æƒ…å†µä¸‹å°±æ— æ³•æ¥å—å®šæ—¶å™¨äº‹ä»¶äº†ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠTimeråŒæ—¶æ·»åŠ åˆ°<code class="highlighter-rouge">UITrackingRunLoopMode</code>å’Œ<code class="highlighter-rouge">kCFRunLoopDefaultMode</code>ä¸Šã€‚
 é‚£ä¹ˆå¦‚ä½•æŠŠtimeråŒæ—¶æ·»åŠ åˆ°å¤šä¸ªmodeä¸Šå‘¢ï¼Ÿå°±è¦ç”¨åˆ°<code class="highlighter-rouge">NSRunLoopCommonModes</code>äº†ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];
</code></pre></div></div>

<p>Timerå°±è¢«æ·»åŠ åˆ°å¤šä¸ªmodeä¸Šï¼Œè¿™æ ·å³ä½¿RunLoopç”±<code class="highlighter-rouge">kCFRunLoopDefaultMode</code>åˆ‡æ¢åˆ°<code class="highlighter-rouge">UITrackingRunLoopMode</code>ä¸‹ï¼Œä¹Ÿä¸ä¼šå½±å“æ¥æ”¶Timeräº‹ä»¶ã€‚</p>

<h4 id="34-cfrunloopsourceref">3.4 CFRunLoopSourceRef</h4>

<p><code class="highlighter-rouge">CFRunLoopSourceRef</code> æ˜¯äº‹ä»¶äº§ç”Ÿçš„åœ°æ–¹ã€‚Sourceæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼šSource0 å’Œ Source1</p>

<ul>
  <li>Source0 åªåŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œå®ƒå¹¶ä¸èƒ½ä¸»åŠ¨è§¦å‘äº‹ä»¶ã€‚ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦å…ˆè°ƒç”¨ <code class="highlighter-rouge">CFRunLoopSourceSignal(source)</code>ï¼Œå°†è¿™ä¸ª Source æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨ <code class="highlighter-rouge">CFRunLoopWakeUp(runloop) </code>æ¥å”¤é†’ RunLoopï¼Œè®©å…¶å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚</li>
  <li>Source1 åŒ…å«äº†ä¸€ä¸ª mach_port å’Œä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œè¢«ç”¨äºé€šè¿‡å†…æ ¸å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯ã€‚è¿™ç§ Source èƒ½ä¸»åŠ¨å”¤é†’ RunLoop çš„çº¿ç¨‹ï¼Œå…¶åŸç†åœ¨ä¸‹é¢ä¼šè®²åˆ°ã€‚</li>
</ul>

<h4 id="35-cfrunloopobserverref">3.5 CFRunLoopObserverRef</h4>

<p><code class="highlighter-rouge">CFRunLoopObserverRef</code>æ˜¯è§‚å¯Ÿè€…ï¼Œç”¨æ¥ç›‘å¬RunLoopçš„çŠ¶æ€æ”¹å˜ã€‚</p>

<p><code class="highlighter-rouge">CFRunLoopObserverRef</code>å¯ä»¥ç›‘å¬çš„çŠ¶æ€æ”¹å˜æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) {
    kCFRunLoopEntry = (1UL &lt;&lt; 0),               // å³å°†è¿›å…¥RunLoopï¼š1
    kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1),        // å³å°†å¤„ç†Timerï¼š2    
    kCFRunLoopBeforeSources = (1UL &lt;&lt; 2),       // å³å°†å¤„ç†Sourceï¼š4
    kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5),       // å³å°†è¿›å…¥ä¼‘çœ ï¼š32
    kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6),        // å³å°†ä»ä¼‘çœ ä¸­å”¤é†’ï¼š64
    kCFRunLoopExit = (1UL &lt;&lt; 7),                // å³å°†ä»Loopä¸­é€€å‡ºï¼š128
    kCFRunLoopAllActivities = 0x0FFFFFFFU       // ç›‘å¬å…¨éƒ¨çŠ¶æ€æ”¹å˜  
};
</code></pre></div></div>

<h3 id="å››runloopåŸç†">å››ã€RunLoopåŸç†</h3>

<p>æ ¹æ®è‹¹æœåœ¨<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Multithreading/RunLoopManagement/RunLoopManagement.html#//apple_ref/doc/uid/10000057i-CH16-SW23">æ–‡æ¡£</a>é‡Œçš„è¯´æ˜ï¼ŒRunLoop å†…éƒ¨çš„é€»è¾‘å¤§è‡´å¦‚ä¸‹:</p>

<p><img src="https://raw.githubusercontent.com/limeng99/limeng99.github.io/master/assets/img/screenshots/runloop-chart.png" alt="runloop-chart" /></p>

<p>å…¶å†…éƒ¨æºç æ•´ç†å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ç”¨DefaultModeå¯åŠ¨
void CFRunLoopRun(void) {	/* DOES CALLOUT */
    int32_t result;
    do {
        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, 1.0e10, false);
        CHECK_FOR_FORK();
    } while (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);
}


// ç”¨æŒ‡å®šçš„Modeå¯åŠ¨ï¼Œå…è®¸è®¾ç½®RunLoopè¶…æ—¶æ—¶é—´
SInt32 CFRunLoopRunInMode(CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled) {     /* DOES CALLOUT */
    CHECK_FOR_FORK();
    return CFRunLoopRunSpecific(CFRunLoopGetCurrent(), modeName, seconds, returnAfterSourceHandled);
}


// RunLoopçš„å®ç°
SInt32 CFRunLoopRunSpecific(CFRunLoopRef rl, CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled) {     /* DOES CALLOUT */
    CHECK_FOR_FORK();
    if (__CFRunLoopIsDeallocating(rl)) return kCFRunLoopRunFinished;
    __CFRunLoopLock(rl);
    // é¦–å…ˆæ ¹æ®modeNameæ‰¾åˆ°å¯¹åº”mode
    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, false);
    if (NULL == currentMode || __CFRunLoopModeIsEmpty(rl, currentMode, rl-&gt;_currentMode)) {
				Boolean did = false;
				if (currentMode) __CFRunLoopModeUnlock(currentMode);
				__CFRunLoopUnlock(rl);
				return did ? kCFRunLoopRunHandledSource : kCFRunLoopRunFinished;
    }
    volatile _per_run_data *previousPerRun = __CFRunLoopPushPerRunData(rl);
    CFRunLoopModeRef previousMode = rl-&gt;_currentMode;
    rl-&gt;_currentMode = currentMode;
    int32_t result = kCFRunLoopRunFinished;
    
		// 1. é€šçŸ¥ Observers: RunLoop å³å°†è¿›å…¥ã€‚
		if (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);
		// å†…éƒ¨å‡½æ•° __CFRunLoopRun
		result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);
		// 10. é€šçŸ¥ Observers: RunLoop å³å°†é€€å‡ºã€‚
		if (currentMode-&gt;_observerMask &amp; kCFRunLoopExit ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);
  	__CFRunLoopModeUnlock(currentMode);
    __CFRunLoopPopPerRunData(rl, previousPerRun);
		rl-&gt;_currentMode = previousMode;
    __CFRunLoopUnlock(rl);
    return result;
}


// å†…éƒ¨å‡½æ•° __CFRunLoopRun
static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) {
		... 
    Boolean didDispatchPortLastTime = true;
    int32_t retVal = 0;
    // å†…éƒ¨æ˜¯ä¸€ä¸ªwhileå¾ªç¯
    do {  
				...
				// 2. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Timer å›è°ƒã€‚
        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);
        // 3. é€šçŸ¥ Observers: RunLoop å³å°†è§¦å‘ Source0 (éport) å›è°ƒã€‚
        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);
				// æ‰§è¡Œè¢«åŠ å…¥çš„block
				__CFRunLoopDoBlocks(rl, rlm);
				// 4. RunLoop è§¦å‘ Source0 (éport) å›è°ƒã€‚
        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);
        if (sourceHandledThisLoop) {
            __CFRunLoopDoBlocks(rl, rlm);
				}
				// 5. å¦‚æœæœ‰ Source1 (åŸºäºport) å¤„äº ready çŠ¶æ€ï¼Œç›´æ¥å¤„ç†è¿™ä¸ª Source1 ç„¶åè·³è½¬å»å¤„ç†æ¶ˆæ¯ã€‚
				if (MACH_PORT_NULL != dispatchPort &amp;&amp; !didDispatchPortLastTime) {
            msg = (mach_msg_header_t *)msg_buffer;
            if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0)) {
                goto handle_msg;
            }
        }
				...
				//  6. é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹å³å°†è¿›å…¥ä¼‘çœ (sleep)ã€‚
				if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);
				__CFRunLoopSetSleeping(rl);
				...
        // 7. è°ƒç”¨ mach_msg ç­‰å¾…æ¥å— mach_port çš„æ¶ˆæ¯ã€‚çº¿ç¨‹å°†è¿›å…¥ä¼‘çœ , ç›´åˆ°è¢«ä¸‹é¢æŸä¸€ä¸ªäº‹ä»¶å”¤é†’
        // 7.1 ä¸€ä¸ªåŸºäº port çš„Source çš„äº‹ä»¶
        // 7.2 ä¸€ä¸ª Timer åˆ°æ—¶é—´äº†
        // 7.3 RunLoop è‡ªèº«çš„è¶…æ—¶æ—¶é—´åˆ°äº†
        // 7.4 è¢«å…¶ä»–ä»€ä¹ˆè°ƒç”¨è€…æ‰‹åŠ¨å”¤é†’
        msg = (mach_msg_header_t *)msg_buffer;
        __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY);
        ... 
        // 8. é€šçŸ¥ Observers: RunLoop çš„çº¿ç¨‹åˆšåˆšè¢«å”¤é†’äº†
				if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);
				...
				// 9. æ”¶åˆ°æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆæ¯ã€‚
        if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) {
        		// 9.1 å¦‚æœä¸€ä¸ª Timer åˆ°æ—¶é—´äº†ï¼Œè§¦å‘è¿™ä¸ªTimerçš„å›è°ƒ
       		 	__CFArmNextTimerInMode(rlm, rl);
       		 	
        } else if (livePort == dispatchPort) {
        		// 9.2 å¦‚æœæœ‰dispatchåˆ°main_queueçš„blockï¼Œæ‰§è¡Œblock
            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)6, NULL);
            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)0, NULL);

        } else {
        		// 9.3 å¤„ç†Source1 (åŸºäºport)
						sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;
        } 

      if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) {
      		// è¿›å…¥loopæ—¶å‚æ•°è¯´å¤„ç†å®Œäº‹ä»¶å°±è¿”å›
          retVal = kCFRunLoopRunHandledSource;
       } else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) {
      	 	// è¶…å‡ºä¼ å…¥å‚æ•°æ ‡è®°çš„è¶…æ—¶æ—¶é—´äº†
           retVal = kCFRunLoopRunTimedOut;
      } else if (__CFRunLoopIsStopped(rl)) {
          // è¢«å¤–éƒ¨è°ƒç”¨è€…å¼ºåˆ¶åœæ­¢äº†
          __CFRunLoopUnsetStopped(rl);
          retVal = kCFRunLoopRunStopped;
      } else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) {
          // source/timer/observerä¸€ä¸ªéƒ½æ²¡æœ‰äº†
          retVal = kCFRunLoopRunFinished;
      }
   	} while (0 == retVal);
   	...
    return retVal;
}
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Š RunLoop å°±æ˜¯è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ª do-while å¾ªç¯ã€‚å½“ä½ è°ƒç”¨ <code class="highlighter-rouge">CFRunLoopRun() </code>æ—¶ï¼Œçº¿ç¨‹å°±ä¼šä¸€ç›´åœç•™åœ¨è¿™ä¸ªå¾ªç¯é‡Œï¼›ç›´åˆ°è¶…æ—¶æˆ–è¢«æ‰‹åŠ¨åœæ­¢ï¼Œè¯¥å‡½æ•°æ‰ä¼šè¿”å›ã€‚</p>

<p>å…·ä½“çš„é¡ºåºå¦‚ä¸‹ï¼š</p>

<ol>
  <li>é€šçŸ¥è§‚å¯Ÿè€…RunLoopå·²ç»å¯åŠ¨</li>
  <li>é€šçŸ¥è§‚å¯Ÿè€…å³å°†è¦å¼€å§‹çš„å®šæ—¶å™¨</li>
  <li>é€šçŸ¥è§‚å¯Ÿè€…ä»»ä½•å³å°†å¯åŠ¨çš„éåŸºäºç«¯å£çš„æº</li>
  <li>å¯åŠ¨ä»»ä½•å‡†å¤‡å¥½çš„éåŸºäºç«¯å£çš„æº</li>
  <li>å¦‚æœåŸºäºç«¯å£çš„æºå‡†å¤‡å¥½å¹¶å¤„äºç­‰å¾…çŠ¶æ€ï¼Œç«‹å³å¯åŠ¨ï¼›å¹¶è¿›å…¥æ­¥éª¤9</li>
  <li>é€šçŸ¥è§‚å¯Ÿè€…çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€</li>
  <li>å°†çº¿ç¨‹ç½®äºä¼‘çœ çŸ¥é“ä»»ä¸€ä¸‹é¢çš„äº‹ä»¶å‘ç”Ÿï¼š
    <ul>
      <li>æŸä¸€äº‹ä»¶åˆ°è¾¾åŸºäºç«¯å£çš„æº</li>
      <li>å®šæ—¶å™¨å¯åŠ¨</li>
      <li>RunLoopè®¾ç½®çš„æ—¶é—´å·²ç»è¶…æ—¶</li>
      <li>RunLoopè¢«æ˜¾ç¤ºå”¤é†’</li>
    </ul>
  </li>
  <li>é€šçŸ¥è§‚å¯Ÿè€…çº¿ç¨‹å°†è¢«å”¤é†’</li>
  <li>å¤„ç†æœªå¤„ç†çš„äº‹ä»¶
    <ul>
      <li>å¦‚æœç”¨æˆ·å®šä¹‰çš„å®šæ—¶å™¨å¯åŠ¨ï¼Œå¤„ç†å®šæ—¶å™¨äº‹ä»¶å¹¶é‡å¯RunLoopã€‚è¿›å…¥æ­¥éª¤2</li>
      <li>å¦‚æœè¾“å…¥æºå¯åŠ¨ï¼Œä¼ é€’ç›¸åº”çš„æ¶ˆæ¯</li>
      <li>å¦‚æœRunLoopè¢«æ˜¾ç¤ºå”¤é†’è€Œä¸”æ—¶é—´è¿˜æ²¡è¶…æ—¶ï¼Œé‡å¯RunLoopã€‚è¿›å…¥æ­¥éª¤2</li>
    </ul>
  </li>
  <li>é€šçŸ¥è§‚å¯Ÿè€…RunLoopç»“æŸã€‚</li>
</ol>

<h3 id="äº”runloop-å®é™…åº”ç”¨">äº”ã€RunLoop å®é™…åº”ç”¨</h3>

<h4 id="51-nstimerçš„ä½¿ç”¨">5.1 NSTimerçš„ä½¿ç”¨</h4>

<p>NSTimerçš„ä½¿ç”¨æ–¹æ³•åœ¨è®²è§£<code class="highlighter-rouge">CFRunLoopTimerRef</code>ç±»çš„æ—¶å€™è¯¦ç»†è®²è§£è¿‡ï¼Œå…·ä½“å‚è€ƒä¸Šè¾¹ <strong>3.3 CFRunLoopTimerRef</strong>ã€‚</p>

<h4 id="52-afnetworking20å¸¸é©»çº¿ç¨‹">5.2 AFNetworking2.0å¸¸é©»çº¿ç¨‹</h4>

<p><code class="highlighter-rouge">AFURLConnectionOperation</code> è¿™ä¸ªç±»æ˜¯åŸºäº <code class="highlighter-rouge">NSURLConnection</code> æ„å»ºçš„ï¼Œå…¶å¸Œæœ›èƒ½åœ¨åå°çº¿ç¨‹æ¥æ”¶ <code class="highlighter-rouge">Delegate</code> å›è°ƒã€‚ä¸ºæ­¤ <code class="highlighter-rouge">AFNetworking</code> å•ç‹¬åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­å¯åŠ¨äº†ä¸€ä¸ª <code class="highlighter-rouge">RunLoop</code>ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+ (void)networkRequestThreadEntryPoint:(id)__unused object {
    @autoreleasepool {
        [[NSThread currentThread] setName:@"AFNetworking"];
        NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
        [runLoop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];
        [runLoop run];
    }
}

+ (NSThread *)networkRequestThread {
    static NSThread *_networkRequestThread = nil;
    static dispatch_once_t oncePredicate;
    dispatch_once(&amp;oncePredicate, ^{
        _networkRequestThread = [[NSThread alloc] initWithTarget:self selector:@selector(networkRequestThreadEntryPoint:) object:nil];
        [_networkRequestThread start];
    });
    return _networkRequestThread;
}
</code></pre></div></div>

<p><code class="highlighter-rouge">RunLoop</code> å¯åŠ¨å‰å†…éƒ¨å¿…é¡»è¦æœ‰è‡³å°‘ä¸€ä¸ª <code class="highlighter-rouge">Timer</code>/<code class="highlighter-rouge">Observer</code>/<code class="highlighter-rouge">Source</code>ï¼Œæ‰€ä»¥ <code class="highlighter-rouge">AFNetworking</code> åœ¨ <code class="highlighter-rouge">[runLoop run]</code> ä¹‹å‰å…ˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ <code class="highlighter-rouge">NSMachPort</code> æ·»åŠ è¿›å»äº†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè°ƒç”¨è€…éœ€è¦æŒæœ‰è¿™ä¸ª <code class="highlighter-rouge">NSMachPort (mach_port)</code> å¹¶åœ¨å¤–éƒ¨çº¿ç¨‹é€šè¿‡è¿™ä¸ª <code class="highlighter-rouge">port</code> å‘é€æ¶ˆæ¯åˆ° <code class="highlighter-rouge">loop</code> å†…ï¼›ä½†æ­¤å¤„æ·»åŠ  <code class="highlighter-rouge">port</code> åªæ˜¯ä¸ºäº†è®© <code class="highlighter-rouge">RunLoop</code> ä¸è‡³äºé€€å‡ºï¼Œå¹¶æ²¡æœ‰ç”¨äºå®é™…çš„å‘é€æ¶ˆæ¯ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- (void)start {
    [self.lock lock];
    if ([self isCancelled]) {
        [self performSelector:@selector(cancelConnection) onThread:[[self class] networkRequestThread] withObject:nil waitUntilDone:NO modes:[self.runLoopModes allObjects]];
    } else if ([self isReady]) {
        self.state = AFOperationExecutingState;
        [self performSelector:@selector(operationDidStart) onThread:[[self class] networkRequestThread] withObject:nil waitUntilDone:NO modes:[self.runLoopModes allObjects]];
    }
    [self.lock unlock];
}
</code></pre></div></div>

<p>å½“éœ€è¦è¿™ä¸ªåå°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œ<code class="highlighter-rouge">AFNetworking</code> é€šè¿‡è°ƒç”¨ <code class="highlighter-rouge">[NSObject performSelector:onThread:..]</code> å°†è¿™ä¸ªä»»åŠ¡æ‰”åˆ°äº†åå°çº¿ç¨‹çš„ <code class="highlighter-rouge">RunLoop</code> ä¸­ã€‚</p>

<h4 id="53-autoreleasepoolé‡Šæ”¾">5.3 AutoreleasePoolé‡Šæ”¾</h4>

<p><code class="highlighter-rouge">App</code>å¯åŠ¨åï¼Œè‹¹æœåœ¨ä¸»çº¿ç¨‹ <code class="highlighter-rouge">RunLoop</code> é‡Œæ³¨å†Œäº†ä¸¤ä¸ª <code class="highlighter-rouge">Observer</code>ï¼Œå…¶å›è°ƒéƒ½æ˜¯ <code class="highlighter-rouge">_wrapRunLoopWithAutoreleasePoolHandler()</code>ã€‚</p>

<p>ç¬¬ä¸€ä¸ª <code class="highlighter-rouge">Observer</code> ç›‘è§†çš„äº‹ä»¶æ˜¯ <code class="highlighter-rouge">Entry(å³å°†è¿›å…¥Loop)</code>ï¼Œå…¶å›è°ƒå†…ä¼šè°ƒç”¨ <code class="highlighter-rouge">_objc_autoreleasePoolPush()</code> åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚å…¶ <code class="highlighter-rouge">order</code> æ˜¯ <code class="highlighter-rouge">-2147483647</code>ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºé‡Šæ”¾æ± å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚</p>

<p>ç¬¬äºŒä¸ª <code class="highlighter-rouge">Observer</code> ç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶ï¼š <code class="highlighter-rouge">BeforeWaiting</code>(å‡†å¤‡è¿›å…¥ä¼‘çœ ) æ—¶è°ƒç”¨<code class="highlighter-rouge">_objc_autoreleasePoolPop()</code>  å’Œ <code class="highlighter-rouge">_objc_autoreleasePoolPush()</code> é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ï¼›<code class="highlighter-rouge">Exit</code>(å³å°†é€€å‡ºLoop) æ—¶è°ƒç”¨ <code class="highlighter-rouge">_objc_autoreleasePoolPop()</code> æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™ä¸ª <code class="highlighter-rouge">Observer</code> çš„ <code class="highlighter-rouge">order</code> æ˜¯ <code class="highlighter-rouge">2147483647</code>ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶é‡Šæ”¾æ± å­å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹åã€‚</p>

<p>åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œé€šå¸¸æ˜¯å†™åœ¨è¯¸å¦‚äº‹ä»¶å›è°ƒã€<code class="highlighter-rouge">Timer</code>å›è°ƒå†…çš„ã€‚è¿™äº›å›è°ƒä¼šè¢« <code class="highlighter-rouge">RunLoop</code> åˆ›å»ºå¥½çš„ <code class="highlighter-rouge">AutoreleasePool</code> ç¯ç»•ç€ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼Œå¼€å‘è€…ä¹Ÿä¸å¿…æ˜¾ç¤ºåˆ›å»º <code class="highlighter-rouge">Pool</code> äº†ã€‚</p>

:ET